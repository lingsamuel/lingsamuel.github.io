<!doctype html><html lang=zh itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=alternate href=https://lingsamuel.github.io/index.xml type=application/rss+xml title="Hakurei Shrine"><link href=https://lingsamuel.github.io/img/favicon.ico rel=icon type=image/x-icon><link rel=stylesheet href=https://lingsamuel.github.io/css/source-serif-text.css><link rel=stylesheet href=https://lingsamuel.github.io/css/fonts.css><link rel=stylesheet href=https://lingsamuel.github.io/css/main.css><link rel=preconnect href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-89095899-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body id=body><nav id=navbar><div class=nav><div class=navbar-header><img src=https://lingsamuel.github.io/img/favicon.ico class=favicon><a href=https://lingsamuel.github.io/>
Hakurei Shrine</a></div><div class=navbar-menu><ul><li><a title=Articles href=/page>Articles</a></li><li><a title=Reviews href=/review>Reviews</a></li><li><a title=Feeds href=/feed>Feeds</a></li><li><a title=Kubernetes href=/k8s>Kubernetes</a></li><li><a title=About href=/about>About</a></li><li><a title=Categories href=/categories>Categories</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div></div></nav><div class=flex-container><div class=container id=mainContainer role=main><header class="header post-header"><div class=row><div class=post-title><h1>Render HTML Statically</h1></div><div class=post-meta><span class=author>Ling Samuel</span>
&bull;
<span class=date>2021-03-09</span>
&bull;
<span class=categories><a href=https://lingsamuel.github.io/categories/programming/>programming</a>&nbsp;</span></div></div></header><div class=row><div><article role=main class=blog-post><p>这个“静态”网站逐渐添加了越来越多的渲染脚本 ($\KaTeX$, Highlight.js, Mermaid.js, 等)。它们极大地拖慢了渲染速度。</p><p>由于这些渲染结果都是一致的，应当移到编译期完成。让静态的归静态。</p><p>最开始，我研究了一下搭配 jsdom 和 jquery 后，Highlight.js, Mermaid.js 在 Node.js 上的表现。我想看看是不是能执行一个非常简单的 Node.js 脚本就能达到我的需求。</p><p>花费了一两个小时后，我放弃了。基本上它们很难在 Node.js 上如在浏览器里一样可用。</p><p>最后的方案还是变成了 Puppeteer。将页面灌到 Chrome 里，然后拿到渲染完毕的 HTML，然后删掉那些渲染脚本。</p><hr><p>首先给渲染脚本的 tag 添加 <code>data-stage="prerender"</code> 属性，以便于后续将它们从 HTML 中删除。</p><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span> <span class=na>data-stage</span><span class=o>=</span><span class=s>&#34;prerender&#34;</span><span class=p>&gt;</span> <span class=nx>renderMathInElement</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>);</span> <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p>然后通过 <a href=https://github.com/lingsamuel/html-post-renderer>Post Renderer</a> 遍历整个生成的 <code>public</code> 目录，忽略掉那些 size 小于 1000 的文件（一般是 Hugo 生成的重定向 HTML），然后将它们一个个灌入 Puppeteer。</p><p>得到生成的 HTML 后，通过 jsdom 和 jquery 把 <code>data-stage="prerender"</code> 的元素全部删除。</p><p>这样就得到了完全渲染好的页面，给 Actions 添加一个新的部署流程，就完成了。目前本站已经应用了这个预渲染方式。</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup Nodejs</span><span class=w>
</span><span class=w>  </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-node@v2</span><span class=w>
</span><span class=w>  </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>node-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;12&#39;</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Pre Render Pages</span><span class=w>
</span><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>mkdir rendered &amp;&amp; cd post-render &amp;&amp; npm install &amp;&amp; node ./render.js .. ../rendered</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy Pre Rendered</span><span class=w>
</span><span class=w>  </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>peaceiris/actions-gh-pages@v3</span><span class=w>
</span><span class=w>  </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>publish_branch</span><span class=p>:</span><span class=w> </span><span class=l>rendered</span><span class=w>
</span><span class=w>    </span><span class=nt>personal_token</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.PERSONAL_TOKEN }}</span><span class=w>
</span><span class=w>    </span><span class=nt>publish_dir</span><span class=p>:</span><span class=w> </span><span class=l>./rendered</span><span class=w>
</span><span class=w>    </span><span class=nt>external_repository</span><span class=p>:</span><span class=w> </span><span class=l>lingsamuel/lingsamuel.github.io</span><span class=w>
</span></code></pre></div><p>这样即使在禁用了 JS 的环境中，也可以获得完整的阅读体验。同时也避免了页面载入后花费几秒钟渲染，然后元素一直在抽搐的问题。这很文明。</p><p>可以通过在 DevTools 中，通过 <code>Ctrl + Shift + P</code> 搜索 <code>Disable Javascript</code> 来测试一下，例如<a href=/page/render-mermaid-without-shortcode/>这个页面</a>。</p><hr><p>目前的预渲染脚本：</p><ul><li>渲染中文引号，<a href=https://github.com/lingsamuel/FuHsi.js>FuHsi.js</a></li><li>预处理 Mermaid 代码块，<a href=https://lingsamuel.github.io/page/render-mermaid-without-shortcode/>避免使用 Shortcode</a></li><li>渲染 Mermaid 图，<a href=https://github.com/mermaid-js/mermaid>mermaid.js</a></li><li>语法高亮，<a href=https://github.com/highlightjs/highlight.js/>highlight.js</a></li><li>数学公式渲染，<a href=https://katex.org/>$\KaTeX$</a></li><li>一些样式处理</li></ul><hr><p>虽然还存在一些问题，例如如果 js/css 文件使用相对路径的话，Puppeteer 会从本地寻找；使用绝对路径的话，会去寻找线上版本，而使得运行的 js/css 实际上低了一个版本。</p><p>由于实际上我只有一个自定义 js，这个问题还不是非常严重，我懒得折腾了。</p><div id=refContainer></div></article></div><div class=post-pager><ul class=pager><li class=previous><a href=https://lingsamuel.github.io/page/render-mermaid-without-shortcode/>&larr; 不使用 Shortcode 渲染 Mermaid 图</a></li><li class=next><a href=https://lingsamuel.github.io/page/2021-04-06-%E8%BF%9C%E7%A6%BB%E7%A4%BE%E4%BA%A4%E7%BD%91%E7%BB%9C/>远离社交网络 &rarr;</a></li></ul></div></div></div></div><footer id=footer><div class=footer><p>Copyright © 2021 Ling Samuel &bull; Powered by <a href=https://gohugo.io>Hugo v0.82.0</a> &bull; Theme <a href=https://github.com/lingsamuel/purity>Purity</a> &bull; Hosted by GitHub</p></div></footer></body></html>