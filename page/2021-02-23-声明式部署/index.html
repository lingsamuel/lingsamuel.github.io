<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>“声明式”部署 - Hakurei Shrine</title><meta property="og:title" content="“声明式”部署"><meta name=twitter:title content="“声明式”部署"><meta name=description content="基于 Helm 与 Kubeapps 自动化部署"><meta property="og:description" content="基于 Helm 与 Kubeapps 自动化部署"><meta name=twitter:description content="基于 Helm 与 Kubeapps 自动化部署"><meta name=author content="Ling Samuel"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Hakurei Shrine","url":"https:\/\/lingsamuel.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/lingsamuel.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/lingsamuel.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/lingsamuel.github.io\/page\/2021-02-23-%E5%A3%B0%E6%98%8E%E5%BC%8F%E9%83%A8%E7%BD%B2\/","name":"“声明式”部署"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Ling Samuel"},"headline":"“声明式”部署","description":"一种基于 Helm 封装的以 Git 仓库为单位的部署包管理模式，和一些吐槽。\n","inLanguage":"en","wordCount":2279,"datePublished":"2021-02-23T17:24:52","dateModified":"2021-02-23T17:24:52","image":"https:\/\/lingsamuel.github.io\/","keywords":[""],"mainEntityOfPage":"https:\/\/lingsamuel.github.io\/page\/2021-02-23-%E5%A3%B0%E6%98%8E%E5%BC%8F%E9%83%A8%E7%BD%B2\/","publisher":{"@type":"Organization","name":"https:\/\/lingsamuel.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/lingsamuel.github.io\/","height":60,"width":60}}}</script><meta property="og:title" content="“声明式”部署"><meta property="og:description" content="基于 Helm 与 Kubeapps 自动化部署"><meta property="og:url" content="https://lingsamuel.github.io/page/2021-02-23-%E5%A3%B0%E6%98%8E%E5%BC%8F%E9%83%A8%E7%BD%B2/"><meta property="og:type" content="website"><meta property="og:site_name" content="Hakurei Shrine"><meta name=twitter:title content="“声明式”部署"><meta name=twitter:description content="基于 Helm 与 Kubeapps 自动化部署"><meta name=twitter:card content="summary"><link href=https://lingsamuel.github.io/img/favicon.ico rel=icon type=image/x-icon><meta name=twitter:card content="summary"><meta property="og:url" content="https://lingsamuel.github.io/page/2021-02-23-%E5%A3%B0%E6%98%8E%E5%BC%8F%E9%83%A8%E7%BD%B2/"><meta property="og:type" content="website"><meta property="og:site_name" content="Hakurei Shrine"><link rel=alternate href=https://lingsamuel.github.io/index.xml type=application/rss+xml title="Hakurei Shrine"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://lingsamuel.github.io/css/highlight.min.css><link rel=stylesheet href=https://lingsamuel.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=https://lingsamuel.github.io/css/main.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-89095899-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body id=body><nav id=navbar class="navbar navbar-default navbar-fixed-top navbar-custom nav-bottom-border"><div class="container-fluid nav-container"><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://lingsamuel.github.io/>Hakurei Shrine</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Articles href=/page>Articles</a></li><li><a title=Reviews href=/review>Reviews</a></li><li><a title=Feeds href=/feed>Feeds</a></li><li class=navlinks-container><a class=navlinks-parent>Translations</a><div class=navlinks-children><a href=/translation/authorized>Authorized Translations</a>
<a href=/translation>Unauthorized Translations</a></div></li><li class=navlinks-container><a class=navlinks-parent>Books</a><div class=navlinks-children><ul class="navlinks-container level-3-menu"><a href=/ class=navlinks-parent>Tech</a><div class="navlinks-children right-menu"><a href=/k8s-book>Kubernetes</a></div></ul></div></li><li><a title=About href=/about>About</a></li><li><a title=Categories href=/categories>Categories</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div id=intro-header class="intro-header no-img"><div class=container><div class=row><div class="col-lg-10 col-lg-offset-1"><div class=page-heading><h1>“声明式”部署</h1><hr class=small><span class=page-subheading>基于 Helm 与 Kubeapps 自动化部署</span></div></div></div></div></div></header><div class=container id=mainContainer role=main><div class=row><div class="col-lg-8 col-lg-offset-1"><article role=main class=blog-post><p>一种基于 Helm 封装的以 Git 仓库为单位的部署包管理模式，和一些吐槽。</p><h2 id=部署困境>部署困境</h2><p>尽管已经使用了 Kubernetes，但很多时候部署并不是更新完 yaml 就结束了。</p><p>一般来讲，大部分时候部署新版本依赖以下额外人工操作：</p><ul><li>更新配置，例如更新 Consul</li><li>更新数据库</li></ul><p>乍一看好像并不是很复杂（甚至非常简单），然而复杂的问题往往是简单问题叠加“历史原因”造成的。</p><p>由于“历史原因”（罪恶，你的名字叫历史包袱！），绝大部分现有的 Consul 配置是单个 key，在 json value 中再根据不同键区分不同服务的配置。</p><p>这带来了一个很显而易见的问题，所有的配置混杂在一起，更改困难。并且一旦某一个服务部署时，改错了配置，受影响的范围可能非常大。</p><p>此外，不同服务的不同配置都储存在一个 monorepo 里。由于历史上比较糟糕的工程化实践，正确地更新这个 monnorepo 里的一部分配置也是一件非常困难的事情。</p><p>monorepo 也有 monorepo 的好处，至少在首次部署的时候非常方便。但问题是不同区域的服务有不同的版本，这时候想正确地从一个不知道多久前的版本更新到新版，绝大部分时候不是直接刷上最新配置即可的事情。据我所知，有的业务线部署甚至需要几天的时间（大多数时候是因为 monorepo 以及不规范带来的各种配置缺漏问题）。</p><p>这些问题在良好的工程实践中是比较难以想象的。</p><h2 id=新的部署模式>新的部署模式</h2><p>一个显而易见的改动，就是必须将不同服务的不同配置拆分到各自的 repo 中，而不是耦合在一个维护混乱的 monorepo 中。配置也应该引入强制性的规则，比如禁止操作其他服务（尤其是基础服务）的配置。</p><p>规范的作用是用来约束他人，提高代码的下限，保证起码的软件工程质量。</p><p>此外，单 key 的配置模式也必须要拆分，这涉及到许多插件的改造，不过多叙述。</p><p>新的部署模式需要有如下的特征：</p><ul><li>单个服务升级方便</li><li>服务升级不应该互相影响</li><li>自动化更新所需的配置</li><li>版本控制</li><li>一些强制的规则检测，拒绝不符合规范的配置</li><li>最好一键完成</li></ul><p>有了这些需求，Helm 显而易见地是目前最简单的选择（当然，也有许多不足之处）。为了提供方便操作的界面（Helm 的命令行固然也可以用，但相对的 values.yaml 修改并不是很方便），还顺带引入了 Kubeapps（不必须）。</p><h2 id=新的构建系统>新的构建系统</h2><p>Helm 本身是一种特别灵活的东西，但从“历史原因”中考虑，灵活往往意味着不可控。大多数时候八股文可以解决的问题，就最好不要开放更多灵活性出来。</p><p>新的构建编写的系统能够：</p><ul><li>根据环境变量与项目自动填充 Chart.yaml</li><li>根据构建脚本里填写的依赖配置，自动填充 Helm 的依赖项</li><li>自动填充必须配置，如环境变量，probe 等</li><li>自动检测特定目录存放的 Consul、SQL 等配置，为其生成 pre-install 等 hooks，实现配置自动更新<ul><li>在这一步还检测了配置项是否违反了一些规则，例如禁止修改其他服务的 consul 配置、禁止修改其他库表</li></ul></li><li>打好的 Helm 包推向 Harbor Helm 仓库；如果是 release 版本，还将同步到生产环境</li></ul><p>这一套系统本质上是对 Helm 包的二次封装，增加了许多限制的同时将配置项规范化，减少了产生垃圾代码的可能。</p><p>此外这套系统还有一些比较奇怪的功能，比如 consul 配置优先级等，比较业务相关，不过多阐述了。</p><p>有了这一套系统，勉强算是可以保证一个 git 提交完打包出来的东西可以直接无痛部署上线了。当然还有一些后续的痛苦工作，比如梳理几百个服务的依赖关系，将各种不合理依赖砍断，将一些服务下沉到基础域，等等，才算真正能保证服务升级不互相影响。</p><p>这套系统还带来了一个额外的好处：通过解析 yaml，能够从一个完整的 Helm 包中自动导出所有需要的镜像。以前需要人工填写大量镜像，现在直接一个脚本全部搞定。</p><p>总而言之，一切都终于自动化起来了。</p><h2 id=一些想法>一些想法</h2><p>这个问题的根本，在我看来本质上似乎并不是一个软件工程问题，而是一个团队管理问题。这个系统推进过程中最大的好处是顺便将“配置管理的责任”与随意的依赖关系厘清了，同时引入了许多强限制，将部署责任也附加到了开发过程中（而不是上线当晚），整体上提高了一大截工程质量，当然能持续多久不好说……</p><p>从软件工程上看，貌似一切问题的根源都可以归根在“缺乏良好的 Code Reivew”上。
但是平心而论，大部分人可能对 Code Review 不感兴趣，毕竟需求繁多人力不足的情况下，code review 是一个不小的负担，何况业务需求强相关的东西别人不一定能看懂。据我观察，项目组的 Leader 也许很精通业务和进度管理，但 leader 本人也有很重的开发责任，review 的工作实在是没有时间。而且，也不是所有人都具备 review 的能力，有能力的人一般都属于“流动项目组”，一般不会在某个业务线里长待，公司内部哪里有需要就去哪里救火。具体到部署包这东西上，往往是上线时问题频出，临时补丁来补丁去，好不容易工作了。在这种环境下，哪来的工程质量可言呢？</p><p>在此之前，我从来没有想过部署一些东西居然会因为“历史包袱”的原因逐渐地变得如此复杂与耗时。在人员质量参差不齐的情况下，也许从构建系统上下手是一个好办法。</p><p>此外，我也完全没想到推动这项声明式部署的方案竟然如此困难……幸而公司恰好新建了一个需要快速部署更新的业务线，恰好赶上这个系统上线，在几个月的实践中内证明了其高效与可用性。由于各种各样的原因，这可能是贵司第一次的“持续交付”实践，尽管由于环境隔离和公司规定，还需要在工单结束后人工在生产环境的 Kubeapps 上点一下更新。</p><p>这可能是公司内部第一个不因为部署加班的业务线，但尽管有如此一个正面典型案例，后续的推广工作也十分困难。观察下来貌似运维和测试都对这个系统好评如潮（这是显然的），但其他业务线根本没有动力去接入。最后还是依靠强制制定的 KPI 要求才终于开始大规模接入……这是我十分难以理解的。</p><p>最后我还特别想吐槽，这套系统可能拥有全公司最完善的使用文档和 FAQ，但几乎没有人看，令人心累。不得不感慨团队管理的本质首先是找人，其次才是找目标——虽然在商业公司中可能是反过来的。</p><div id=refContainer></div></article></div><aside id=toc class=col-lg-2><nav id=TableOfContents><ul><li><a href=#部署困境>部署困境</a></li><li><a href=#新的部署模式>新的部署模式</a></li><li><a href=#新的构建系统>新的构建系统</a></li><li><a href=#一些想法>一些想法</a></li></ul></nav></aside></div></div><footer><div class=container><div class=row><div class="col-lg-10 col-lg-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:lingsamuelgrace@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/lingsamuel title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://lingsamuel.github.io/index.xml title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=lingsamuel.github.io>Ling Samuel</a>
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://lingsamuel.github.io/>Hakurei Shrine</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.80.0</a> powered &nbsp;&bull;&nbsp; Theme by <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a> adapted to <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> Modified by <a href=https://github.com/lingsamuel>LingSamuel</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://lingsamuel.github.io/js/main.js></script><script src=https://lingsamuel.github.io/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://lingsamuel.github.io/js/load-photoswipe.js></script></body></html>