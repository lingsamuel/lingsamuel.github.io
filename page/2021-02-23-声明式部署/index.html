<!doctype html><html lang=zh itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>“声明式”部署 - Hakurei Shrine</title><link rel=alternate href=https://lingsamuel.github.io/index.xml type=application/rss+xml title="Hakurei Shrine"><link href=https://lingsamuel.github.io/img/favicon.ico rel=icon type=image/x-icon alt=favicon><link rel=preconnect href=https://fonts.gstatic.com><link rel=preload href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@100;300;400;500;700;900&family=Noto+Serif+SC:wght@200;300;400;500;600;700;900&family=Source+Serif+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap" media=screen as=style onload="this.rel='stylesheet'"><link rel=stylesheet href=https://lingsamuel.github.io/css/main.min.a75e9a599682a731cee0a85bca08677793ccfed66b75983788d267df77f8389b.css integrity="sha256-p16aWZaCpzHO4Khbyghnd5PM/tZrdZg3iNJn33f4OJs=" media=screen><link rel=stylesheet href=https://lingsamuel.github.io/css/book.min.4b0b8750931e5fac50e9f925eb06212025c38f696da645ae3b37180ebdcce4d3.css integrity="sha256-SwuHUJMeX6xQ6fkl6wYhICXDj2ltpkWuOzcYDr3M5NM=" media=screen><link rel=stylesheet href=https://lingsamuel.github.io/css/source-serif-text.min.c9da0ad693ce3a1c2c04f7a6eb65a3953cb830ab0316c8ba5f230f86aad7b486.css integrity="sha256-ydoK1pPOOhwsBPem62WjlTy4MKsDFsi6XyMPhqrXtIY=" media=screen><link rel=stylesheet href=https://lingsamuel.github.io/css/fonts.min.be7b7799e9be973d7c45a07910948ba48cf2cbb2f23a123eaf479ab8985d395b.css integrity="sha256-vnt3mem+lz18RaB5EJSLpIzyy7LyOhI+r0eauJhdOVs=" media=screen><link rel=preload href=https://lingsamuel.github.io/css/fira-code.min.311370d25700134bbb9a194f401aded40a90707976f08528042a506e5f0306ef.css integrity="sha256-MRNw0lcAE0u7mhlPQBre1AqQcHl28IUoBCpQbl8DBu8=" media=screen as=style onload="this.rel='stylesheet'"><link rel=preload href=https://lingsamuel.github.io/css/math-symbol.min.de044ea9623db3709e697fd61ab5698bf4bac9a737e77b4449579b0a56d70c29.css integrity="sha256-3gROqWI9s3CeaX/WGrVpi/S6yac353tESVebClbXDCk=" media=screen as=style onload="this.rel='stylesheet'"><link data-dep=katex rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-89095899-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body id=body><nav id=navbar><div class=nav><div class=navbar-header><img src=https://lingsamuel.github.io/img/favicon.ico class=favicon><a href=https://lingsamuel.github.io/>
Hakurei Shrine</a></div><div class=navbar-menu><ul><li><a title=Articles href=/page>Articles</a></li><li><a title=Reviews href=/review>Reviews</a></li><li><a title=Feeds href=/feed>Feeds</a></li><li><a title=Kubernetes href=/k8s>Kubernetes</a></li><li><a title=About href=/about>About</a></li><li><a title=Categories href=/categories>Categories</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div></div></nav><div class=flex-container><div class="container container-single" id=mainContainer role=main><header class="header post-header"><div class=row><div class=post-title><h1>“声明式”部署</h1><hr class=small><h3 class=post-subtitle>基于 Helm 与 Kubeapps 的自动化部署</h3></div><div class=post-meta><span class=author>Ling Samuel</span>
&bull;
<span class=date>2021-02-23</span>
&bull;
<span class=categories><a href=https://lingsamuel.github.io/categories/kubernetes/>kubernetes</a>&nbsp;</span></div></div></header><div class=row><div><article role=main class=post-content><p>一种基于 Helm 封装的以 Git 仓库为单位的部署包管理模式，和一些吐槽。</p><h2 id=部署困境>部署困境</h2><p>尽管已经使用了 Kubernetes，但很多时候部署并不是更新完 yaml 就结束了。</p><p>当前部署的困难在于环境隔离。我们的系统并不是公网服务，环境也是隔离的，这导致自动化的工作比较困难。</p><p>此外，由于在全国各地也有无数的环境，版本也不一，加上配置繁多，正确地从任意一个版本升级到新版是一件比较困难的事情。其中涉及到大量的人工操作，例如传输镜像包、配置等。数十个镜像和数百个配置文件，人工操作很容易缺漏、出错，导致每次部署都耗时很长。</p><p>一般来讲，大部分时候部署新版本依赖以下额外人工操作：</p><ul><li>更新配置，例如更新 Consul</li><li>更新数据库</li></ul><p>乍一看好像并不是很复杂（甚至非常简单），然而复杂的问题往往是简单问题叠加“历史原因”造成的。</p><p>由于“历史原因”（罪恶，你的名字叫历史包袱！），绝大部分现有的 Consul 配置是单个 key，在 json value 中再根据不同键区分不同服务的配置。</p><p>这带来了一个很显而易见的问题，所有的配置混杂在一起，更改困难。并且一旦某一个服务部署时，改错了配置，受影响的范围可能非常大。</p><p>此外，不同服务的不同配置都储存在一个 monorepo 里。由于历史上比较糟糕的工程化实践，正确地找到并更新这个 monnorepo 里的一部分配置也是一件非常困难的事情。</p><p>monorepo 也有 monorepo 的好处，至少在首次部署的时候非常方便。但问题是不同区域的服务有不同的版本，这时候想正确地从一个不知道多久前的版本更新到新版，绝大部分时候不是直接刷上最新配置即可的事情。据我所知，有的业务线部署甚至需要几天的时间（大多数时候是因为 monorepo 以及不规范带来的各种配置缺漏问题）。</p><p>这些问题在良好的工程实践中是比较难以想象的。</p><h2 id=新的部署模式>新的部署模式</h2><p>鉴于 monorepo 维护配置具有诸多坏处，包括但不限于：</p><ul><li>没有权限区分以及缺乏 review，经常有人为了“能用”乱改配置、不按规范改，造成服务间配置耦合十分严重。</li><li>开发网并不使用这套部署包，部署包的问题可能在部署当晚才发现。由于着急上线，很可能大量产生临时补丁，耦合和不规范性超级加倍。</li><li>由于所有服务的配置都在一起，修改时可能并不在意是否引入了新的耦合。很多时候为了某个服务能工作反而修改了其他服务的配置。这导致了很多问题。</li><li>部署包本身是一堆 Shell 脚本，维护比较困难。加上灵活性太大，经常有垃圾代码产生。</li></ul><p>一个显而易见的改动，就是必须将不同服务的不同配置拆分到各自的 repo 中，而不是耦合在一个维护混乱的 monorepo 中。这些配置也应该引入强制性的规则，比如禁止操作其他服务（尤其是基础服务）的配置。</p><p>规范的作用是用来约束他人，提高代码的下限，保证起码的软件工程质量。</p><p>此外，单 key 的配置模式也必须要拆分，这涉及到许多插件与服务的改造，不过多叙述。</p><p>新的部署模式需要有如下的特征：</p><ul><li>开发与生产需要统一成一种部署方式</li><li>单个服务升级方便</li><li>服务升级不应该互相影响</li><li>自动化更新所需的配置</li><li>版本控制</li><li>一些强制的规则检测，拒绝不符合规范的配置</li><li>最好一键完成</li></ul><p>有了这些需求，Helm 显而易见地是目前最简单的选择（当然，也有许多不足之处）。为了提供方便操作的界面（Helm 的命令行固然也可以用，但相对的 values.yaml 修改并不是很方便），还顺带引入了 Kubeapps（不必须）。</p><h2 id=新的构建系统>新的构建系统</h2><p>Helm 本身是一种特别灵活的东西。从“历史原因”中考虑，灵活往往意味着不可控。大多数时候八股文可以解决的问题，就最好不要开放更多灵活性出来。</p><p>因此引入 Helm 时必须提供一组相对固定的配置，从这组配置里自动生成 Helm 包，而不是各服务自己从头编写。这还带来了一个好处，一些 yaml 的更新不需要通知到所有 repo 修改，只需要构建系统修改即可。</p><p>新的构建系统还有一个重要的目的就是减少部署过程中人力的干预，人工干预越少，错误就（相对来说）越少。</p><p>新的构建编写的系统能够：</p><ul><li>根据环境变量与项目自动填充 Chart.yaml</li><li>根据构建脚本里填写的依赖服务，自动填充 Helm 的依赖项</li><li>自动填充必须的 yaml 配置，如环境变量，probe 等</li><li>自动检测特定目录存放的 Consul、SQL 等配置，为其生成 pre-install 等 hooks，实现配置的自动更新<ul><li>在这一步还检测了配置项是否违反了一些规则，例如禁止修改其他服务的 consul 配置、禁止修改其他库表、检测其他 SQL 规范等</li></ul></li><li>打好的 Helm 包推向 Harbor Helm 仓库；如果是 release 版本，还需要自动同步所需镜像、Helm 包到生产环境</li></ul><p>这一套系统本质上是对 Helm 包的二次封装，增加了许多限制的同时将配置项规范化，减少了产生垃圾代码的可能。此外引入了几个自动化程序来代替人工更新配置。</p><p>这套系统还有一些比较奇怪的功能，比如 consul 配置的优先级等，比较业务相关，不过多阐述了。</p><p>有了这一套系统，勉强算是可以保证一个 git 提交完打包出来的东西可以直接无痛部署上线了。当然还有一些后续的痛苦工作，比如梳理几百个服务的依赖关系，将各种不合理依赖砍断，将一些服务下沉到基础域，等等，才算真正能保证服务升级不互相影响。</p><hr><p>这套系统也没有丢失 monorepo “一键部署”的好处。</p><p>从 git 的 commit message 中可以判断是否是 release 版本。在实践中，根据是否是 release 版本可以导出不同的配置，例如：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=k>if</span> is_release<span class=p>;</span> <span class=k>then</span>
  <span class=nb>export</span> <span class=nv>REPLICA</span><span class=o>=</span><span class=m>30</span>
<span class=k>else</span>
  <span class=nb>export</span> <span class=nv>REPLICA</span><span class=o>=</span><span class=m>3</span>
<span class=k>if</span>
</code></pre></div><p>如果有一些额外的配置，例如不同环境的某些依赖服务路径不同，也可以通过 checkout 分支来实现。</p><p>这使得生成的 helm 包的 values.yaml 是直接可用的，无需人工配置，解放了人力。</p><p>由于一个业务线可能有数十个服务，一个个部署也比较困难，还可以新建一个空 Repo，在构建脚本中 require 一堆服务，即可产生一个“一键部署包”，例如：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm_require app-a 1.0.1
helm_require app-b 1.2.3
</code></pre></div><p>Helm 体系（尤其是这个总包的实践）还带来了一个额外的好处：在过去部署时，需要人工寻找镜像列表，然后传输，这是非常容易缺漏错的。但现在通过解析总包，能够从一个完整的 Helm 包中自动导出所有需要的镜像。以前需要人工填写大量镜像，现在直接一个脚本全部搞定、自动同步镜像。</p><p>总而言之，一切都终于自动化起来了。目前的链路中只需要一次公司规定必须有的人工干预（在 Kubeapps 上点击升级版本）。截止目前已经服务于数个业务线支撑了数十个服务的数百次部署。</p><h2 id=一些想法>一些想法</h2><p>这个问题的根本，在我看来本质上似乎并不是一个软件工程问题，而是一个团队管理问题。</p><p>这个系统推进过程中最大的好处是顺便将“配置管理的责任”与数十数百个服务间随意的依赖关系厘清了，将部署责任也附加到了开发过程中（而不是上线当晚）。同时引入了许多强限制，整体上提高了一大截工程质量。并且将部署过程中的人力干预几乎减少到 0。</p><p>从软件工程上看，貌似一切问题的根源都可以归根在“缺乏良好的 Code Reivew”上。</p><p>但是平心而论，大部分人可能对 code review 不感兴趣，毕竟需求繁多人力不足的情况下，code review 是一个不小的负担，何况业务需求强相关的东西别人不一定能看懂。据我观察，项目组的 leader 也许很精通业务和进度管理，但 leader 本人也有很重的开发责任，review 的工作实在是没有时间。而且，也不是所有人都具备 review 的能力，有能力的人一般都属于“流动项目组”，一般不会在某个业务线里长待，公司内部哪里有需要就去哪里救火。</p><p>具体到部署包这东西上，由于开发环境与部署环境的割裂，往往是上线时问题频出，临时补丁来补丁去，好不容易工作了。在这种环境下，哪来的工程质量可言呢？</p><p>在此之前，我从来没有想过部署一些东西居然会因为“历史包袱”的原因逐渐地变得如此复杂与耗时。在人员质量参差不齐的情况下，也许从构建系统上下手是一个好办法。</p><p>此外，我也完全没想到推动这项声明式部署的方案竟然如此困难……幸而公司恰好新建了一个需要快速部署更新的业务线，恰好赶上这个系统上线，恰好这个团队就在隔壁工位。这条业务线在几个月的实践中内证明了这套部署流程的高效与可用性。由于各种各样的原因，这可能是公司内部第一次“持续交付”实践——虽然由于环境隔离和公司规定，还需要在工单结束后人工在生产环境的 Kubeapps 上点一下更新，但相比过去可以说是从无到有的进步。</p><p>这可能是公司内部第一个不因为部署加班的业务线，但尽管有如此一个正面典型案例，后续的推广工作也十分困难。观察下来虽然运维和测试都对这个系统好评如潮，但其他业务线似乎根本没有动力去接入。最后还是依靠强制制定的 KPI 要求才终于开始大规模接入……这是我十分难以理解的。</p><p>最后我还特别想吐槽，这套系统可能拥有全公司最完善的使用文档和 FAQ，但几乎没有人看，令人心累。不得不感慨团队管理的本质首先是找人，其次才是找目标——虽然在商业公司中可能是反过来的。</p><div id=refContainer></div></article></div><div class=post-pager><ul class=pager><li class=previous><a href=https://lingsamuel.github.io/page/2021-02-23-teaching-abstractly/>&larr; 抽象地讲述是教学的核心</a></li><li class=next><a href=https://lingsamuel.github.io/page/2021-03-02-%E4%B8%AD%E8%8B%B1%E6%96%87%E6%B7%B7%E6%8E%92%E8%87%AA%E5%8A%A8%E5%A4%84%E7%90%86%E5%BC%95%E5%8F%B7/>中英文混排：自动处理引号 &rarr;</a></li></ul></div></div></div><div id=toc><aside><nav id=TableOfContents><ul><li><a href=#部署困境>部署困境</a></li><li><a href=#新的部署模式>新的部署模式</a></li><li><a href=#新的构建系统>新的构建系统</a></li><li><a href=#一些想法>一些想法</a></li></ul></nav></aside></div></div><footer id=footer><div class=footer><p>Copyright © 2021
<a href=https://lingsamuel.github.io>Ling Samuel</a> &bull; Powered by <a href=https://gohugo.io>Hugo v0.82.0</a> &bull; Theme <a href=https://github.com/lingsamuel/purity>Purity</a> &bull;
Hosted by GitHub</p></div></footer><script data-stage=prerender src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script data-stage=prerender src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><link rel=stylesheet href=https://lingsamuel.github.io/css/mermaid.min.f57f100e5c31122c8fd948b8716faca0b33177ff6b2234c983c71a5da37fe839.css integrity="sha256-9X8QDlwxEiyP2Ui4cW+soLMxd/9rIjTJg8caXaN/6Dk=" media=screen><script data-stage=prerender src=https://lingsamuel.github.io/js/mermaid.min.js></script><script data-stage=prerender>const mermaidKeywords=["graph TD","graph TB","graph BT","graph RL","graph LR","sequenceDiagram","gantt","classDiagram","gitGraph","erDiagram","journey"];function colorizeMermaid(a){const b=`
      linkStyle default fill:none,stroke:grey;
      classDef default stroke:#97999a,color:#696874;
      classDef def stroke:#97999a,color:#696874;
      classDef Blue stroke:#97999a,fill:#76aac2,color:#eff1f3;
      classDef Grey stroke:#97999a,fill:#696773,color:#eef0f2;
      classDef Red stroke:#97999a,fill:#f19b97,color:#fcefee;
      classDef Green stroke:#97999a,fill:#79d8ce,color:#edf0f2;
      classDef Yellow stroke:#97999a,fill:#fcd766,color:#807971;
      
      classDef Yellow1 stroke:#97999a,fill:#ffe85f,color:#807971;
      classDef Yellow2 stroke:#97999a,fill:#f2cc2c,color:#edf0f2;
      classDef Green1 stroke:#97999a,fill:#15ffd8,color:#807971;
      classDef Green2 stroke:#97999a,fill:#18e8c0,color:#807971;
      classDef Green3 stroke:#97999a,fill:#18d3af,color:#edf0f2;
      classDef Green4 stroke:#97999a,fill:#17bf9f,color:#edf0f2;
      classDef Red1 stroke:#97999a,fill:#ff6679,color:#fcefee;
      classDef Red2 stroke:#97999a,fill:#f45d6b,color:#fcefee;
      classDef Red3 stroke:#97999a,fill:#ff505d,color:#fcefee;
      classDef Red4 stroke:#97999a,fill:#db424d,color:#fcefee;
      classDef Blue1 stroke:#97999a,fill:#61b0ff,color:#eff1f3;
      classDef Blue2 stroke:#97999a,fill:#3b8bff,color:#eff1f3;
      classDef Purple1 stroke:#97999a,fill:#c2a2d5,color:#807971;
      classDef Purple2 stroke:#97999a,fill:#986fb5,color:#807971;
      classDef Orange1 stroke:#97999a,fill:#ffb164,color:#807971;
      classDef Orange2 stroke:#97999a,fill:#f9973e,color:#807971;
  `;return a.startsWith("graph")?a+b:a}var elements=Array.from(document.getElementsByClassName("language-fallback")).forEach((b,d)=>{var c=b.innerText,a;mermaidKeywords.some(a=>c.startsWith(a))&&(a=b.parentElement.parentElement,a.className=="highlight"&&(a.className="mermaid",a.innerHTML=colorizeMermaid(c),a.align="center",a.style="background: #eff1f3;"))})</script><script data-stage=prerender>mermaid.initialize({startOnLoad:!1}),mermaid.mermaidAPI.initialize();function cyrb53(c,d=0){let a=3735928559^d,b=1103547991^d;for(let d=0,e;d<c.length;d++)e=c.charCodeAt(d),a=Math.imul(a^e,2654435761),b=Math.imul(b^e,1597334677);return a=Math.imul(a^a>>>16,2246822507)^Math.imul(b^b>>>13,3266489909),b=Math.imul(b^b>>>16,2246822507)^Math.imul(a^a>>>13,3266489909),4294967296*(2097151&b)+(a>>>0)}let existed={};function calculateHash(b){let a=cyrb53(b);return typeof existed[a]=="number"&&(a=existed[a]+1),existed[a]=a,a}document.querySelectorAll('.mermaid').forEach(function(b){let a=b.textContent;console.log("Rendering ",a);let c="graph-"+calculateHash(a);mermaid.mermaidAPI.render(c,a,a=>{b.innerHTML=a})})</script><script data-stage=prerender>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})</script><script data-stage=prerender src=https://lingsamuel.github.io/js/fuhsi.js></script><script data-stage=prerender>fuhsi()</script></body></html>