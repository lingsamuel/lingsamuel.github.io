<!doctype html><html lang=zh itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>一次 K8s 集群修复日志 - Hakurei Shrine</title><link rel=alternate href=https://lingsamuel.github.io/index.xml type=application/rss+xml title="Hakurei Shrine"><link href=https://lingsamuel.github.io/img/favicon.ico rel=icon type=image/x-icon alt=favicon><link rel=stylesheet href=https://lingsamuel.github.io/css/main.min.1402f5c5c6383807c899aa1b78e6e7b88116059e24f89a6f2df3195e70dfa4d6.css integrity="sha256-FAL1xcY4OAfImaobeObnuIEWBZ4k+JpvLfMZXnDfpNY=" media=screen><link rel=stylesheet href=https://lingsamuel.github.io/css/book.min.4b0b8750931e5fac50e9f925eb06212025c38f696da645ae3b37180ebdcce4d3.css integrity="sha256-SwuHUJMeX6xQ6fkl6wYhICXDj2ltpkWuOzcYDr3M5NM=" media=screen><link rel=stylesheet href=https://lingsamuel.github.io/css/source-serif-text.min.c9da0ad693ce3a1c2c04f7a6eb65a3953cb830ab0316c8ba5f230f86aad7b486.css integrity="sha256-ydoK1pPOOhwsBPem62WjlTy4MKsDFsi6XyMPhqrXtIY=" media=screen><link rel=stylesheet href=https://lingsamuel.github.io/css/fonts.min.8c7cdb109cdcfdc41e1509b588ad9330dcf3d8ae8ba96dc5be2e1935aa7c30e2.css integrity="sha256-jHzbEJzc/cQeFQm1iK2TMNzz2K6LqW3Fvi4ZNap8MOI=" media=screen><link rel=preload href=https://lingsamuel.github.io/css/fira-code.min.311370d25700134bbb9a194f401aded40a90707976f08528042a506e5f0306ef.css integrity="sha256-MRNw0lcAE0u7mhlPQBre1AqQcHl28IUoBCpQbl8DBu8=" media=screen as=style onload="this.rel='stylesheet'"><link rel=preload href=https://lingsamuel.github.io/css/math-symbol.min.de044ea9623db3709e697fd61ab5698bf4bac9a737e77b4449579b0a56d70c29.css integrity="sha256-3gROqWI9s3CeaX/WGrVpi/S6yac353tESVebClbXDCk=" media=screen as=style onload="this.rel='stylesheet'"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-89095899-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body id=body><nav id=navbar><div class=nav><div class=navbar-header><img src=https://lingsamuel.github.io/img/favicon.ico class=favicon><a href=https://lingsamuel.github.io/>
Hakurei Shrine</a></div><div class=navbar-menu><ul><li><a title=Articles href=/page>Articles</a></li><li><a title=Reviews href=/review>Reviews</a></li><li><a title=Feeds href=/feed>Feeds</a></li><li><a title=Kubernetes href=/k8s>Kubernetes</a></li><li><a title=About href=/about>About</a></li><li><a title=Categories href=/categories>Categories</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div></div></nav><div class=flex-container><div class=container id=mainContainer role=main><header class="header post-header"><div class=row><div class=post-title><h1>一次 K8s 集群修复日志</h1></div><div class=post-meta><span class=author>Ling Samuel</span>
&bull;
<span class=date>2020-07-17</span>
&bull;
<span class=categories><a href=https://lingsamuel.github.io/categories/kubernetes/>kubernetes</a>&nbsp;</span>
&bull;
<span class=tags><a href=https://lingsamuel.github.io//tags/linux/>linux</a>&nbsp;
<a href=https://lingsamuel.github.io//tags/k8s/>k8s</a>&nbsp;</span></div></div></header><div class=row><div><article role=main class=post-content><p>离谱。</p><h2 id=起因>起因</h2><p>集群过载一段时间之后，K8s 的 <code>node</code> 突然统统消失了。</p><p>随后节点 1 和节点 2 恢复，其余节点始终没有自愈。</p><h2 id=恢复>恢复</h2><p>重启 <code>kubelet</code> 可以恢复节点，但是不重启的节点始终没有自愈。</p><p>查看 <code>kubelet</code> 的日志发现大量 <code>Unexpected watch close - watch lasted less than a second and no items received</code> 和 <code>use of closed network connection</code> 的错误日志，貌似<code>kubelet</code> 用了死掉的链接。</p><p>从 <a href=https://github.com/kubernetes/kubernetes/issues/87615>(1.17) Kubelet won&rsquo;t reconnect to Apiserver after NIC failure (use of closed network connection)</a> <a href=https://github.com/kubernetes/kubernetes/issues/87615#issuecomment-647915537>来看</a>，这还是个和 Golang 有关的 <a href=https://github.com/golang/go/issues/39750>bug</a>……</p><p>期间由于部分节点提前恢复，导致大量的 pod 调度到其上，导致资源占满，DaemonSet <code>calico</code> 的 pod 始终 Pending，kill 掉大量 pod 即可恢复。</p><p>随后发现 <code>calico</code> Unhealthy，网络依旧存在问题。</p><p>通过 <code>calicoctl node status</code> 发现节点 2 的 IP 因为神秘原因<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> 错误，并非 <code>eth0</code> 的 IP。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>ETCD_KEY_FILE</span><span class=o>=</span><span class=s2>&#34;/etc/kubernetes/ssl/etcd-key.pem&#34;</span>
<span class=nb>export</span> <span class=nv>ETCD_CERT_FILE</span><span class=o>=</span><span class=s2>&#34;/etc/kubernetes/ssl/etcd.pem&#34;</span>
<span class=nb>export</span> <span class=nv>ETCD_CA_CERT_FILE</span><span class=o>=</span><span class=s2>&#34;/etc/kubernetes/ssl/ca.pem&#34;</span>
<span class=nb>export</span> <span class=nv>ETCD_ENDPOINTS</span><span class=o>=</span><span class=s2>&#34;https://IP1,https://IP2,https://IP3:2379&#34;</span>
calicoctl get node -o yaml &gt; calico-node2.yaml
<span class=c1># 修正 calico-node2.yaml</span>
calicoctl replace -f ./calico-node2.yaml
</code></pre></div><p>修复 IP 即可恢复。</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>这是由于节点上有人偷偷给 docker 添加了一个 network，而 calico 工作在 autodetect 模式的缘故。 <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><div id=refContainer></div></article></div><div class=post-pager><ul class=pager><li class=previous><a href=https://lingsamuel.github.io/page/2020-07-14-customization/>&larr; GNOME Customization Backup</a></li><li class=next><a href=https://lingsamuel.github.io/page/2020-07-17-gnome-cannot-unlock-bug/>GNOME 的无法解锁 Bug &rarr;</a></li></ul></div></div></div><div id=toc><aside><nav id=TableOfContents><ul><li><a href=#起因>起因</a></li><li><a href=#恢复>恢复</a></li></ul></nav></aside></div></div><footer id=footer><div class=footer><p>Copyright © 2021 <a href=https://lingsamuel.github.io>Ling Samuel</a> &bull; Powered by <a href=https://gohugo.io>Hugo v0.82.0</a> &bull; Theme <a href=https://github.com/lingsamuel/purity>Purity</a> &bull; Hosted by GitHub</p></div></footer></body></html>