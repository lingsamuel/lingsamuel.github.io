<!DOCTYPE html><html lang="zh" itemscope="" itemtype="http://schema.org/WebPage"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>StatefulSet Controller 实现 - Hakurei Shrine</title><meta property="og:title" content="StatefulSet Controller 实现"><meta name="twitter:title" content="StatefulSet Controller 实现"><meta name="author" content="Ling Samuel"><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Hakurei Shrine","url":"https:\/\/lingsamuel.github.io\/"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/lingsamuel.github.io\/"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/lingsamuel.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/lingsamuel.github.io\/k8s\/controller\/statefulset\/","name":"Stateful set controller 实现"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","author":{"name":"Ling Samuel"},"headline":"StatefulSet Controller 实现","description":"","inLanguage":"en","wordCount":4612,"datePublished":"2021-03-12T11:34:04","dateModified":"2021-03-12T11:34:04","image":"https:\/\/lingsamuel.github.io\/","keywords":[""],"mainEntityOfPage":"https:\/\/lingsamuel.github.io\/k8s\/controller\/statefulset\/","publisher":{"@type":"Organization","name":"https:\/\/lingsamuel.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/lingsamuel.github.io\/","height":60,"width":60}}}</script><meta property="og:title" content="StatefulSet Controller 实现"><meta property="og:url" content="https://lingsamuel.github.io/k8s/controller/statefulset/"><meta property="og:type" content="website"><meta property="og:site_name" content="Hakurei Shrine"><meta name="twitter:title" content="StatefulSet Controller 实现"><meta name="twitter:card" content="summary"><link href="https://lingsamuel.github.io/img/favicon.ico" rel="icon" type="image/x-icon"><meta name="twitter:card" content="summary"><meta property="og:url" content="https://lingsamuel.github.io/k8s/controller/statefulset/"><meta property="og:type" content="website"><meta property="og:site_name" content="Hakurei Shrine"><link rel="alternate" href="https://lingsamuel.github.io/index.xml" type="application/rss+xml" title="Hakurei Shrine"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&amp;display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code&amp;display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="https://lingsamuel.github.io/css/highlight.min.css"><link rel="stylesheet" href="https://lingsamuel.github.io/css/codeblock.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous"><link rel="stylesheet" href="https://lingsamuel.github.io/css/main.css"><script type="application/javascript">var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-89095899-1','auto'),ga('send','pageview'))</script><script async="" src="https://www.google-analytics.com/analytics.js"></script></head><body id="body"><nav id="navbar" class="navbar navbar-default navbar-fixed-top navbar-custom nav-bottom-border"><div class="container-fluid nav-container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div style="display:flex"><a class="navbar-brand" style="display:flex" href="https://lingsamuel.github.io/"><img src="https://lingsamuel.github.io/img/favicon.ico" style="margin-right:5px;height:1em">Hakurei Shrine</a></div></div><div class="collapse navbar-collapse" id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a title="Articles" href="/page">Articles</a></li><li><a title="Reviews" href="/review">Reviews</a></li><li><a title="Feeds" href="/feed">Feeds</a></li><li><a title="Kubernetes" href="/k8s">Kubernetes</a></li><li><a title="About" href="/about">About</a></li><li><a title="Categories" href="/categories">Categories</a></li><li><a title="Tags" href="/tags">Tags</a></li></ul></div></div></nav><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title="Share"></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><header class="header-section"><div id="intro-header" class="intro-header no-img" style="margin-top: 148px;"><div class="container"><div class="row"><div class="col-lg-11 col-lg-offset-1"><div class="page-heading"><h1>StatefulSet Controller 实现</h1><hr class="small"><div class="post-meta" style="display:flex;justify-content:space-between"><span style="display:inline-flex">Posted on March 12, 2021
by Ling Samuel</span><div style="display:inline-flex;font-style:normal"><span></span>&nbsp;
<a style="text-align:right" href="https://lingsamuel.github.io/k8s/statefulset/" onclick="return event.preventDefault(),function(a){navigator.clipboard.writeText(a.href),$(a).prev().text(&quot;url copied&quot;),setTimeout(function(){$(a).prev().text(&quot;&quot;)},1e3)}(this)">Copy Eternal Link</a></div></div><div class="blog-categories"><a href="https://lingsamuel.github.io/categories/kubernetes/">kubernetes</a>&nbsp;</div></div></div></div></div></div></header><div class="container" id="mainContainer" role="main"><div class="row"><div class="col-lg-8 col-lg-offset-1"><article role="main" class="blog-post"><h2 id="state-in-kubernetes">State in Kubernetes</h2><p>在讲解 StatefulSet 的实现前，我们需要先看一看 Kubernetes 是如何跟踪有状态对象的。</p><h3 id="controllerrevision">ControllerRevision</h3><p>对于有状态的数据，K8s 使用称为 ControllerRevision (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/vendor/k8s.io/api/apps/v1/types.go#L822-L834">src</a>)、且其中存储的数据（<code>Data</code> 字段）<strong>不可变</strong>的对象来存储状态数据。Revision 对象虽然不能更新，但可以删除。</p><p>目前 K8s 内部的 DaemonSet 和 StatefulSet 使用了这个对象：</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs coffeescript" data-lang="go"><span class="kd">type</span> <span class="nx">ControllerRevision</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`<span class="javascript">json:<span class="hljs-string">",inline"</span></span>`</span>
	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`<span class="javascript">json:<span class="hljs-string">"metadata,omitempty"</span> protobuf:<span class="hljs-string">"bytes,1,opt,name=metadata"</span></span>`</span>
	<span class="c1"><span class="hljs-regexp">//</span> Data <span class="hljs-keyword">is</span> the serialized representation <span class="hljs-keyword">of</span> the state.
</span><span class="c1"></span>	<span class="nx">Data</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">RawExtension</span> <span class="s">`<span class="javascript">json:<span class="hljs-string">"data,omitempty"</span> protobuf:<span class="hljs-string">"bytes,2,opt,name=data"</span></span>`</span>
	<span class="c1"><span class="hljs-regexp">//</span> Revision indicates the revision <span class="hljs-keyword">of</span> the state represented <span class="hljs-keyword">by</span> Data.
</span><span class="c1"></span>	<span class="nx">Revision</span> <span class="kt">int64</span> <span class="s">`<span class="javascript">json:<span class="hljs-string">"revision"</span> protobuf:<span class="hljs-string">"varint,3,opt,name=revision"</span></span>`</span>
<span class="p">}</span>
</code></pre></div><p>其中，<code>Data</code> 字段存储了序列化的状态，一旦生成就不可变；<code>Revision</code> 字段表示 Data 中数据的版本号，这个字段是可变的。<code>Data</code> 中存储的内容则取决于使用者如何使用。</p><p>对 Controller Revision 的管理功能位于 <a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/history/controller_history.go">controller_revision.go</a>。</p><p>在集群内部，Controller Revision 与其他对象并无区别。</p><h2 id="实现原理">实现原理</h2><p>在 StatefulSet 的实现中，StatefulSet 直接持有的对象为 Pod 和 Controller Revision。</p><div class="mermaidTitle" style="background:#eff1f3;color:#696874"><strong align="center" style="display:block;font-size:24px;font-family:noto sans">StatefulSet Structure</strong>
<span align="center" style="display:block;font-size:12px;font-family:noto sans">Ling Samuel</span></div><div class="mermaid" align="center" style="background: rgb(239, 241, 243);"><svg id="graph-4523062661825998" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="150" style="max-width: 479.03125px;" viewBox="0 0 479.03125 150"><style>#graph-4523062661825998{font-family:"trebuchet ms",verdana,arial;font-size:16px;fill:#333;}#graph-4523062661825998 .error-icon{fill:#552222;}#graph-4523062661825998 .error-text{fill:#552222;stroke:#552222;}#graph-4523062661825998 .edge-thickness-normal{stroke-width:2px;}#graph-4523062661825998 .edge-thickness-thick{stroke-width:3.5px;}#graph-4523062661825998 .edge-pattern-solid{stroke-dasharray:0;}#graph-4523062661825998 .edge-pattern-dashed{stroke-dasharray:3;}#graph-4523062661825998 .edge-pattern-dotted{stroke-dasharray:2;}#graph-4523062661825998 .marker{fill:#333333;}#graph-4523062661825998 .marker.cross{stroke:#333333;}#graph-4523062661825998 svg{font-family:"trebuchet ms",verdana,arial;font-size:16px;}#graph-4523062661825998 .label{font-family:"trebuchet ms",verdana,arial;color:#333;}#graph-4523062661825998 .label text{fill:#333;}#graph-4523062661825998 .node rect,#graph-4523062661825998 .node circle,#graph-4523062661825998 .node ellipse,#graph-4523062661825998 .node polygon,#graph-4523062661825998 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#graph-4523062661825998 .node .label{text-align:center;}#graph-4523062661825998 .node.clickable{cursor:pointer;}#graph-4523062661825998 .arrowheadPath{fill:#333333;}#graph-4523062661825998 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#graph-4523062661825998 .flowchart-link{stroke:#333333;fill:none;}#graph-4523062661825998 .edgeLabel{background-color:#e8e8e8;text-align:center;}#graph-4523062661825998 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#graph-4523062661825998 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#graph-4523062661825998 .cluster text{fill:#333;}#graph-4523062661825998 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#graph-4523062661825998:root{--mermaid-font-family:"trebuchet ms",verdana,arial;}#graph-4523062661825998 .default > *{stroke:#97999a !important;color:#696874 !important;}#graph-4523062661825998 .default tspan{fill:#696874 !important;}#graph-4523062661825998 .def > *{stroke:#97999a !important;color:#696874 !important;}#graph-4523062661825998 .def tspan{fill:#696874 !important;}#graph-4523062661825998 .Blue > *{stroke:#97999a !important;fill:#76aac2 !important;color:#eff1f3 !important;}#graph-4523062661825998 .Blue tspan{fill:#eff1f3 !important;}#graph-4523062661825998 .Grey > *{stroke:#97999a !important;fill:#696773 !important;color:#eef0f2 !important;}#graph-4523062661825998 .Grey tspan{fill:#eef0f2 !important;}#graph-4523062661825998 .Red > *{stroke:#97999a !important;fill:#f19b97 !important;color:#fcefee !important;}#graph-4523062661825998 .Red tspan{fill:#fcefee !important;}#graph-4523062661825998 .Green > *{stroke:#97999a !important;fill:#79d8ce !important;color:#edf0f2 !important;}#graph-4523062661825998 .Green tspan{fill:#edf0f2 !important;}#graph-4523062661825998 .Yellow > *{stroke:#97999a !important;fill:#fcd766 !important;color:#807971 !important;}#graph-4523062661825998 .Yellow tspan{fill:#807971 !important;}#graph-4523062661825998 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-S LE-R1" id="L-S-R1" style="opacity: 1;"><path class="path" d="M215.04296875,39.82433923794916L55.3515625,75L55.3515625,100" marker-end="url(#arrowhead10)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead10" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-S LE-R2" id="L-S-R2" style="opacity: 1;"><path class="path" d="M234.90735394021738,50L200.0546875,75L200.0546875,100" marker-end="url(#arrowhead11)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead11" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-S LE-P1" id="L-S-P1" style="opacity: 1;"><path class="path" d="M293.4598335597826,50L328.3125,75L328.3125,100" marker-end="url(#arrowhead12)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead12" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-S LE-P2" id="L-S-P2" style="opacity: 1;"><path class="path" d="M313.32421875,41.847849736906376L440.125,75L440.125,100" marker-end="url(#arrowhead13)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead13" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-S-R1" class="edgeLabel L-LS-S' L-LE-R1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-S-R2" class="edgeLabel L-LS-S' L-LE-R2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-S-P1" class="edgeLabel L-LS-S' L-LE-P1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-S-P2" class="edgeLabel L-LS-S' L-LE-P2"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node Green" id="flowchart-S-13" transform="translate(264.18359375,29)" style="opacity: 1;"><rect rx="5" ry="5" x="-49.140625" y="-21" width="98.28125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-39.140625,-11)"><foreignObject width="78.28125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">StatefulSet</div></foreignObject></g></g></g><g class="node Red" id="flowchart-R1-14" transform="translate(55.3515625,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-47.3515625" y="-21" width="94.703125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-37.3515625,-11)"><foreignObject width="74.703125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Revision 1</div></foreignObject></g></g></g><g class="node Red" id="flowchart-R2-15" transform="translate(200.0546875,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-47.3515625" y="-21" width="94.703125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-37.3515625,-11)"><foreignObject width="74.703125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Revision 2</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-P1-16" transform="translate(328.3125,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.90625" y="-21" width="61.8125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.90625,-11)"><foreignObject width="41.8125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod 1</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-P2-17" transform="translate(440.125,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.90625" y="-21" width="61.8125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.90625,-11)"><foreignObject width="41.8125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod 2</div></foreignObject></g></g></g></g></g></g></svg></div><p>基本上 Informer 监听自身资源和 Pod 增删改之类的逻辑和 ReplicaSet/Deployment 类似，除非有特殊逻辑，否则不再赘述。</p><h3 id="sync">sync</h3><p>直接快进到同步函数。</p><p>同步前，<code>sync</code> 会调用 <code>adoptOrphanRevisions</code> 来收养符合 StatefulSet Selectors 的孤儿 Revisions：</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ssc</span> <span class="o">*</span><span class="nx">StatefulSetController</span><span class="p">)</span> <span class="nf">adoptOrphanRevisions</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">StatefulSet</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">revisions</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nf">ListRevisions</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">)</span>
	<span class="nx">orphanRevisions</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ControllerRevision</span><span class="p">,</span> <span class="mi"><span class="hljs-number">0</span></span><span class="p">)</span>
	<span class="k"><span class="hljs-keyword">for</span></span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">revisions</span> <span class="p">{</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">GetControllerOf</span><span class="p">(</span><span class="nx">revisions</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">orphanRevisions</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">orphanRevisions</span><span class="p">,</span> <span class="nx">revisions</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nb"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">orphanRevisions</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="p"><span class="hljs-function">&gt;</span></span><span class="hljs-function"> </span><span class="mi"><span class="hljs-function">0</span></span><span class="hljs-function"> </span><span class="p">{</span>
		<span class="nx">canAdoptErr</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nf">canAdoptFunc</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">)()</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">canAdoptErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s"><span class="hljs-string">"can't adopt ControllerRevisions: %v"</span></span><span class="p">,</span> <span class="nx">canAdoptErr</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nf">AdoptOrphanRevisions</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">,</span> <span class="nx">orphanRevisions</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k"><span class="hljs-keyword">return</span></span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>其中 <code>canAdoptFunc</code> 是实时的 DeletionTimestamp 存在性检测，没有具体的业务逻辑。</p><hr><p>随后，类似其他控制器，调用 <code>getPodsForStatefulSet</code> 获取所有可以被该 StatefulSet 管理的 Pod，同时也处理了收养、释放逻辑。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ssc</span> <span class="o">*</span><span class="nx">StatefulSetController</span><span class="p">)</span> <span class="nf">getPodsForStatefulSet</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">StatefulSet</span><span class="p">,</span> <span class="nx">selector</span> <span class="nx">labels</span><span class="p">.</span><span class="nx">Selector</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pods</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">podLister</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nf">Everything</span><span class="p">())</span>

	<span class="nx">filter</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="kt"><span class="hljs-keyword">bool</span></span> <span class="p">{</span>
		<span class="k"><span class="hljs-keyword">return</span></span> <span class="nf">isMemberOf</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">,</span> <span class="nx">pod</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">cm</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">NewPodControllerRefManager</span><span class="p">(</span><span class="nx">ssc</span><span class="p">.</span><span class="nx">podControl</span><span class="p">,</span> <span class="nx"><span class="hljs-built_in">set</span></span><span class="p">,</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">controllerKind</span><span class="p">,</span> <span class="nx">ssc</span><span class="p">.</span><span class="nf">canAdoptFunc</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">))</span>
	<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">cm</span><span class="p">.</span><span class="nf">ClaimPods</span><span class="p">(</span><span class="nx">pods</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>注意 <code>filter</code> 函数，内部调用了 <code>isMemberOf</code>，该函数检测 Pod 的名字是否符合 StatefulSet 所管理的特征。</p><p>被 StatefulSet 所管理的 Pod，其名字需要是 StatefulSet 的名字 (<code>parentName</code>) 跟上一个序列号 (<code>ordinal</code>) (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/statefulset/stateful_set_utils.go#L87-L87">src</a>)：</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go"><span class="kd"><span class="hljs-function">func</span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodName</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">*</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">apps</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">StatefulSet</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">ordinal</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="p">{</span>
	<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s"><span class="hljs-string">"%s-%d"</span></span><span class="p">,</span> <span class="nx"><span class="hljs-built_in">set</span></span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">ordinal</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>此处的 <code>isMemberOf</code> 函数就检测了该 Pod 是否符合 parentName。</p><hr><p>在获取了需要被同步的 StatefulSet 及其需要管理的 Pod 列表后，调用 <code>syncStatefulSet</code> 将逻辑转发到 <code>StatefulSetControlInterface</code> 的 <code>UpdateStatefulSet</code> 中。</p><p>出于测试目的，一部分 StatefulSet 的核心逻辑被抽成了 <code>StatefulSetControlInterface</code>，其中就包括同步被 StatefulSet 及其管理的 Pod 的部分。</p><h3 id="statefulset-control">StatefulSet Control</h3><p>默认的 StatefulSet Control 实现，其默认的 Pod 同步策略有一个非常重要的假设：按 Pod 序号升序依次扩容，且所有 Pod 都需要健康，才能创建下一个 Pod；缩容时，则是按序号的降序依次停止。</p><p>当然该实现也提供了 burst 策略，可以放宽这个限制。我们稍后会提到这个设计的取舍。</p><hr><p>对外暴露的函数 <code>UpdateStatefulSet</code> 将执行以下逻辑 (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/statefulset/stateful_set_control.go#L74-L74">src</a>)：</p><ul><li>获取该 ss 的所有 revisions，并排序。</li><li>根据 revisions 和 pods，调用 <code>performUpdate</code> 进行更新处理。</li><li>限制 revisions 数量，使之符合 Spec.RevisionHistoryLimit。</li></ul><p>这一块的逻辑相对简单，我们重点关注实际的更新函数。</p><hr><p>函数 <code>performUpdate</code> 主要有三个关键步骤 (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/statefulset/stateful_set_control.go#L92-L92">src</a>)：</p><ul><li>调用 <code>getStatefulSetRevisions</code>，计算 ss 的当前 revision，并获得需要达到的 update revision。</li><li>根据 update revision，调用 <code>updateStatefulSet</code> 来实际应用 update revision。</li><li>调用 <code>updateStatefulSetStatus</code>，更新 ss 的状态。</li></ul><h4 id="getstatefulsetrevisions">getStatefulSetRevisions</h4><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>Note:</strong><p>由于 <code>revision</code> 在这里有三个不同的含义，提前说明其表述差异：</p><ul><li>revision/revision 对象：小写或明确有指代对象。指代 Controller Revision 这个 API 对象。</li><li>Revision：首字母大写。由于 Controller Revision 没有 <code>Spec</code> 字段，所以其持有的 Revision 成员没有一个合适的前缀明确表示其为成员变量。因此下文会使用首字母大写的 <code>Revision</code> 表示 Controller Revision 对象持有的 <code>.Revision</code> 字段。</li><li>revision number：计算出来的 Revision 具体值。</li></ul></div><p>本函数计算并创建/更新一个 update revision 对象。</p><p>获得计算出来的 update revision 之后，会从历史 revisions 中查找是否有相同的 revision。</p><ul><li>历史版本中有相同的 revision：<ul><li>如果该 revision 恰好是最新的 revision，那么直接使用这个，并且不递增 revision（这表明此次同步没有变动，依旧在处理上一次未完成的变更）。</li><li>如果相同 revision 并非最新的一个，将会把这个 revision 的 <code>.Revision</code> 字段更新为递增之后的最新 revision number。</li></ul></li><li>历史版本中没有相同的 revision，则直接创建一个新的 revision 对象。</li></ul><p>在 StatefulSet 的实现里，revision 对象实际持有的数据被称为 patch，通过 <code>getPatch</code> (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/statefulset/stateful_set_utils.go#L288-L288">src</a>) 函数计算得到。该函数虽然语义上生成的是 strategy patch，似乎应该是增量的。但为了避免复杂性，实际上生成的是 <code>spec.template</code> 字段的全量复制，合并策略是 <code>replace</code>。</p><p>生成 revision 对象时，除了会记录 patch 和 revision number 外，同时也会复制 StatefulSet 的所有 Labels 以及 Annotations，此外还有一个记录哈希冲突的 collision count。</p><h4 id="updatestatefulset">updateStatefulSet</h4><p>这个接近 300 行函数是 StatefulSet 业务逻辑的核心实现。</p><p>该函数会按如下步骤执行：</p><ul><li>以 Pod 序号 (ordinal) 为顺序，找出需要保留或更新的 Pods，放入 <code>replicas</code> slice（长度等于 <code>.Spec.Replicas</code>）中；超出的需要被删除的 Pods 则放入 <code>condemned</code>。<ul><li>这一步还会根据 Pod 的 Revision 匹配当前或 update revision 来更新 Status 中的相应数据。</li><li>注意之前的 <code>filter</code> 函数筛查 Pod 列表时，没有处理 Ordinal 不是数字的情形，因此此处还忽略了那些不能解析的非法 Pod。</li></ul></li><li>用新版的 Pod 对象填满 replicas 数组。创建 Pod 的函数为 <code>newVersionedStatefulSetPod</code>。</li><li>计算 replicas 和 condemned slice 中 Unhealthy 的 Pod 数量（打日志用），并找到第一个 Unhealthy 的 Pod。</li><li>如果 SS 的 DeletionTimestamp 不为空，退出。<ul><li>这一步可以提前。在曾经的旧代码中，更新 SS 的状态也是在函数内完成的，因此这一步需要在更新状态之后。
不过在新版的代码中，状态更新被剥离到外部了，因此这一步之所以这么靠后，可能是重构时的遗留。</li></ul></li></ul><p>数据准备阶段到此结束。在这一步中，生成了全新的 Status，划分出了需要保留和删除的 Pod 列表，并且找到了第一个不健康的 Pod。</p><p>现在，我们需要根据 <code>replicas</code> slice 里存储的目标 Pod，进行扩缩容，同时执行 Pod 的健康检查。</p><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>Note:</strong><p>这一阶段填充的 Pod，取决于 Partition 与 UpdateStrategy，其 PodTemplate 可能为 current revision 而非 update revision。</p><p>后文的 UpdateStrategy 一节，将更详尽地阐述相关行为。</p></div><h5 id="扩容">扩容</h5><p>在执行扩容前，需先获取更新 Pod 管理策略。当 <code>PodManagementPolicy</code> 为 <code>OrderedReady</code> 时，SS 将依序检测 Pod 的状态，一次只更新一个 Pod，且只有当上一个 Pod Ready 且 Running（或者缩容情况下的 Terminated）时，才会处理下一个 Pod。当策略为 <code>Parallel</code> 时，则会并发地更新。</p><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>Note:</strong><p>OrderedReady 策略保证了 Pod 是按顺序可用的。</p><p>但由于目前实现的问题，如果 SS 在更新后的状态是错误的而永远无法 Ready &amp; Running，例如引用了不存在的镜像，那么将会在第一个发生错误的 Pod 处卡死。并且因为该 Pod 的状态并未被 SS 控制器 handle，这个损坏的 Pod 也不再会被移除，即使 PodTemplate 更新成了正确的版本。</p></div><p>当检测到 Pod 状态为 <code>Failed</code> 时，将该 Pod 删除，并更新 Status。然后创建一个新的 Pod 对象，替换掉 <code>replicas</code> slice 里的旧 Pod。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go">	<span class="k"><span class="hljs-keyword">for</span></span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">replicas</span> <span class="p">{</span>
		<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">isFailed</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="p">{</span>
			<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">podControl</span><span class="p">.</span><span class="nf">DeleteStatefulPod</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">,</span> <span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="nx">currentRevision</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
				<span class="nx">status</span><span class="p">.</span><span class="nx">CurrentReplicas</span><span class="o">--</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="nx">updateRevision</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
				<span class="nx">status</span><span class="p">.</span><span class="nx">UpdatedReplicas</span><span class="o">--</span>
			<span class="p">}</span>
			<span class="nx">status</span><span class="p">.</span><span class="nx">Replicas</span><span class="o">--</span>
			<span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">newVersionedStatefulSetPod</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
		<span class="p">}</span>
</code></pre></div><p>接着检测 Pod 的状态是否为空。这可能是数据准备阶段填充的新 Pod，也可能是上一步中重建的 Pod。若 Pod 的状态为空，则发起创建请求。同样地，需要更新 status。</p><p>由于 OrderedReady 策略要求一次只更新一个 Pod，因此如果这一步中发起了一个创建请求，那么本次同步就提前结束，直到下次同步时再处理后续的 Pod。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go">		<span class="k"><span class="hljs-keyword">if</span></span> <span class="p">!</span><span class="nf">isCreated</span><span class="p">(</span><span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">podControl</span><span class="p">.</span><span class="nf">CreateStatefulPod</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">,</span> <span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="nx">status</span><span class="p">.</span><span class="nx">Replicas</span><span class="o">++</span>
			<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="nx">currentRevision</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
				<span class="nx">status</span><span class="p">.</span><span class="nx">CurrentReplicas</span><span class="o">++</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="nx">updateRevision</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
				<span class="nx">status</span><span class="p">.</span><span class="nx">UpdatedReplicas</span><span class="o">++</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">monotonic</span> <span class="p">{</span>
				<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-keyword">continue</span></span>
		<span class="p">}</span>
</code></pre></div><p>接下来考虑其他 OrderedReady 策略下的其他 Pod 状态。如果 Pod 的 DeletionTimestamp 不为空，那么说明该 Pod 需要被删除，而删除尚未完成，因此依旧需要等待，提前终止本轮同步。若 Pod 的状态不为 Ready 以及 Running，则说明该 Pod 依旧在启动中，因此需要等待，提前终止本轮同步。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs objectivec" data-lang="go">		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nf">isTerminating</span><span class="p">(</span><span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">monotonic</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="kc"><span class="hljs-literal">nil</span></span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="p">!</span><span class="nf">isRunningAndReady</span><span class="p">(</span><span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">monotonic</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="kc"><span class="hljs-literal">nil</span></span>
		<span class="p">}</span>
</code></pre></div><p>到这一步的 Pod 都处于健康状态。函数会检查它的各种元数据（Pod 名、NS 和 Labels 里记录的 <code>statefulset.kubernetes.io/pod-name</code>）和卷挂载信息是否符合 SS。如果符合就处理下一个 Pod，不符合就通过 StatefulSet Pod Control 的 <code>UpdateStatefulPod</code> 函数更新该 Pod 的元数据和卷挂载信息。</p><p>当上述所有检测与行为，保证了当前 Pod 处于健康状态。并且还创建了所有的新增 Pod 和 Failed Pod，更新了挂载信息，保证了元数据的一致。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go">		<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">identityMatches</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o"><span class="hljs-function">&amp;&amp;</span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">storageMatches</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">replicas</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="p">{</span>
			<span class="k"><span class="hljs-keyword">continue</span></span>
		<span class="p">}</span>
		<span class="c1"><span class="hljs-comment">// Make a deep copy so we don't mutate the shared cache</span>
</span><span class="c1"></span>		<span class="nx">replica</span> <span class="o">:=</span> <span class="nx">replicas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">DeepCopy</span><span class="p">()</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">podControl</span><span class="p">.</span><span class="nf">UpdateStatefulPod</span><span class="p">(</span><span class="nx">updateSet</span><span class="p">,</span> <span class="nx">replica</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div><p>当策略为 Parallel 时，上述所有的提前终止行为 (return) 变成处理下一个 Pod (continue)。</p><p>但是，这一步实际上尚未对现有 Pod 进行额外操作。</p><p>因此我们在这一步结束时，实际上有一组全新的、符合要求的新 Pod，和一组持有旧的 PodTemplate，但有新 Volumes 的 Pod。</p><h5 id="缩容">缩容</h5><p>在这一步中，我们能保证 <code>[0, Replicas)</code> 数量的 Pod 已经完全健康了。因此，可以开始删除不需要的 Pod 了。</p><p>考虑策略为 OrderedReady 时的情形。当 Pod 处于 Terminated 时，提前终止本轮，以等待 Pod 被完全删除。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go">	<span class="k"><span class="hljs-keyword">for</span></span> <span class="nx">target</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">condemned</span><span class="p">)</span> <span class="o">-</span> <span class="mi"><span class="hljs-number">1</span></span><span class="p">;</span> <span class="nx">target</span> <span class="o">&gt;=</span> <span class="mi"><span class="hljs-number">0</span></span><span class="p">;</span> <span class="nx">target</span><span class="o">--</span> <span class="p">{</span>
		<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">isTerminating</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">condemned</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="p">{</span>
			<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">monotonic</span> <span class="p">{</span>
				<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-keyword">continue</span></span>
		<span class="p">}</span>
</code></pre></div><p>随后进行一个 Sanity Check。如果当前处理的 Pod 不健康，那么检查第一个不健康的 Pod 是否等于当前 Pod。由于上面的扩容策略中不会更新缓存（调用 UpdateStatefulPod 前进行了一次 deep clone），这理论上似乎并不会发生。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs objectivec" data-lang="go">		<span class="k"><span class="hljs-keyword">if</span></span> <span class="p">!</span><span class="nf">isRunningAndReady</span><span class="p">(</span><span class="nx">condemned</span><span class="p">[</span><span class="nx">target</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">monotonic</span> <span class="o">&amp;&amp;</span> <span class="nx">condemned</span><span class="p">[</span><span class="nx">target</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">firstUnhealthyPod</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="kc"><span class="hljs-literal">nil</span></span>
		<span class="p">}</span>
</code></pre></div><p>上述检测都通过后，可以安全删除当前处理的 Pod，然后提前终止本轮。当然，也要注意更新 Status。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go">		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssc</span><span class="p">.</span><span class="nx">podControl</span><span class="p">.</span><span class="nf">DeleteStatefulPod</span><span class="p">(</span><span class="nx"><span class="hljs-built_in">set</span></span><span class="p">,</span> <span class="nx">condemned</span><span class="p">[</span><span class="nx">target</span><span class="p">]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">condemned</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="nx">currentRevision</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
			<span class="nx">status</span><span class="p">.</span><span class="nx">CurrentReplicas</span><span class="o">--</span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">condemned</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="nx">updateRevision</span><span class="p">.</span><span class="nx">Name</span> <span class="p">{</span>
			<span class="nx">status</span><span class="p">.</span><span class="nx">UpdatedReplicas</span><span class="o">--</span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">monotonic</span> <span class="p">{</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div><p>当策略为 Parallel 时，行为与扩容阶段一致，所有的提前终止行为改为处理下一个 Pod。</p><h5 id="滚动更新">滚动更新</h5><p>现在我们的扩缩容已经进行完毕了。接下来的工作是清理旧的 Pod，以便将它们更新为最新的 PodTemplate。</p><p>注意，如果 UpdateStrategy（注意更新策略和前文提到的 Pod 管理策略的差异）为 OnDelete，那么 SS 的同步将终止。该策略期待用户手动删除 Pod，从而在下一次同步时，在扩容阶段填充新的 Pod（以便响应 PodTemplate 的变动）。</p><p>清理旧 Pod 然后更新至新 Pod 的行为与缩容类似，是逆序进行的。</p><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>Note:</strong><p>注意，Rolling Update 不受 PodManagementPolicy 控制，也没有类似 MaxSurge 或 MaxUnavailable 等参数。每一轮的删除都仅仅只会删除一个 Pod。</p></div><p>当 Pod 的 revision number 不是最新且 DeletionTimestamp 为空时，该 Pod 将会删除，并更新 SS 的状态。</p><p>当 Pod 的 revision number 匹配最新但 Pod 并未 Ready &amp; Running 时，将提前终止本轮，以等待 Pod 就绪。</p><h6 id="分区更新-partition">分区更新 (Partition)</h6><p>有时候，可能需要只升级一小部分 Pod 来进行测试、灰度发布等工作。对于 Deployment 等无状态资源来说，只需要新创建一个即可。但是由于 SS 绑定了 PV，新创建的 SS 不能继承原有 PV 的数据，可能不符合需求。因此，Kubernetes 提供了 Partition 功能。</p><blockquote><p>如果声明了 partition，当 StatefulSet 的 .spec.template 被更新时，所有序号大于等于该分区序号的 Pod 都会被更新。所有序号小于该分区序号的 Pod 都不会被更新，并且，即使他们被删除也会依据之前的版本进行重建。</p></blockquote><p>Partition 的实现非常讨巧 (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/statefulset/stateful_set_utils.go#L262-L273">src</a>)：</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go"><span class="kd"><span class="hljs-function">func</span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">newVersionedStatefulSetPod</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">currentSet</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">updateSet</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">*</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">apps</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">StatefulSet</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">currentRevision</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">updateRevision</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">ordinal</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="o"><span class="hljs-function">*</span></span><span class="nx"><span class="hljs-function">v1</span></span><span class="p"><span class="hljs-function">.</span></span><span class="nx"><span class="hljs-function">Pod</span></span><span class="hljs-function"> </span><span class="p">{</span>
	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">currentSet</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">UpdateStrategy</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">apps</span><span class="p">.</span><span class="nx">RollingUpdateStatefulSetStrategyType</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="nx">currentSet</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">UpdateStrategy</span><span class="p">.</span><span class="nx">RollingUpdate</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">ordinal</span> <span class="p">&lt;</span> <span class="nb"><span class="hljs-keyword">int</span></span><span class="p">(</span><span class="nx">currentSet</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">CurrentReplicas</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="nx">currentSet</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">UpdateStrategy</span><span class="p">.</span><span class="nx">RollingUpdate</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">ordinal</span> <span class="p">&lt;</span> <span class="nb"><span class="hljs-keyword">int</span></span><span class="p">(</span><span class="o">*</span><span class="nx">currentSet</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">UpdateStrategy</span><span class="p">.</span><span class="nx">RollingUpdate</span><span class="p">.</span><span class="nx">Partition</span><span class="p">))</span> <span class="p">{</span>
		<span class="nx">pod</span> <span class="o">:=</span> <span class="nf">newStatefulSetPod</span><span class="p">(</span><span class="nx">currentSet</span><span class="p">,</span> <span class="nx">ordinal</span><span class="p">)</span>
		<span class="nf">setPodRevision</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">currentRevision</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">pod</span>
	<span class="p">}</span>
	<span class="nx">pod</span> <span class="o">:=</span> <span class="nf">newStatefulSetPod</span><span class="p">(</span><span class="nx">updateSet</span><span class="p">,</span> <span class="nx">ordinal</span><span class="p">)</span>
	<span class="nf">setPodRevision</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">updateRevision</span><span class="p">)</span>
	<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">pod</span>
<span class="p">}</span>
</code></pre></div><p>设我们现在更新策略为 RollingUpdate，Replica 数为 R，Paritiaon 为 P。那么，在创建新 Pod 时，Ordinal 位于 [0, P) 的 Pod 会使用 current revision，而位于 [P, R) 的则会使用 update revision。这样就保证了无论是新建的 Pod 还是重建的 Pod，都能满足 partition 的需要。</p><p>同时也要注意计算时的 Replicas 与 Partition 的值使用的是 current set 而不是 update set。</p><h4 id="updatestatefulsetstatus">updateStatefulSetStatus</h4><p>这一步比较简单。它检查了 Rolling Update 情况下的相关状态是否达到了要求，然后相应地将 Status 的 CurrentRevision 更新为新的 Revision。</p><p>注意，它仅仅在 Rolling Update 策略下，状态符合预期时才会更新 CurrentRevision。</p><p>这是因为，在 UpdateStrategy 为 OnDelete 的情况下，没有分区功能，所有的扩容、重建直接使用最新的 SS 里的 PodTemplate 就可以了，不需要存储 Revision。</p><p>实际上，若 <code>Partition == 0</code>，那么 Rolling Update 对于 Revision 的使用也仅仅只是追踪滚动更新状态罢了。而 OnDelete 时，一切删除都是用户手动进行的，自然也无需追踪了。</p><h3 id="statefulset-pod-control">StatefulSet Pod Control</h3><p>提供 PVC 创建，以及有序 Pod 创建与删除，Pod 校验等额外功能的封装。</p><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>TODO</strong></div><div id="refContainer"></div></article><ul class="pager blog-pager"><li class="previous"><a href="https://lingsamuel.github.io/k8s/controller/replicaset/" data-toggle="tooltip" data-placement="top" title="ReplicaSet Controller 实现">← Previous Post</a></li></ul></div><aside id="toc" class="col-lg-2" style="top: 128px;"><nav id="TableOfContents"><ul><li class=""><a href="#state-in-kubernetes">State in Kubernetes</a><ul><li class="active"><a href="#controllerrevision">ControllerRevision</a></li></ul></li><li><a href="#实现原理">实现原理</a><ul><li><a href="#sync">sync</a></li><li><a href="#statefulset-control">StatefulSet Control</a></li><li><a href="#statefulset-pod-control">StatefulSet Pod Control</a></li></ul></li></ul></nav></aside></div></div><footer><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1"><ul class="list-inline text-center footer-links"><li><a href="mailto:lingsamuelgrace@gmail.com" title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://github.com/lingsamuel" title="GitHub"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://lingsamuel.github.io/index.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href="https://lingsamuel.github.io">Ling Samuel</a>
&nbsp;•&nbsp;©
2021
&nbsp;•&nbsp;
<a href="https://lingsamuel.github.io/">Hakurei Shrine</a></p><p class="credits theme-by text-muted"><a href="http://gohugo.io">Hugo v0.81.0</a> powered &nbsp;•&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> Modified by <a href="https://github.com/lingsamuel/beautifulhugo">LingSamuel</a></p></div></div></div></footer><script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><script src="https://lingsamuel.github.io/js/main.js"></script><link href="https://lingsamuel.github.io/css/mermaid.css" type="text/css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://lingsamuel.github.io/js/load-photoswipe.js"></script></body></html>