<!DOCTYPE html><html lang="zh" itemscope="" itemtype="http://schema.org/WebPage"><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>ReplicaSet Controller 实现 - Hakurei Shrine</title><meta property="og:title" content="ReplicaSet Controller 实现"><meta name="twitter:title" content="ReplicaSet Controller 实现"><meta name="description" content="ReplicationController 的代码已经与 ReplicaSet 合并了。"><meta property="og:description" content="ReplicationController 的代码已经与 ReplicaSet 合并了。"><meta name="twitter:description" content="ReplicationController 的代码已经与 ReplicaSet 合并了。"><meta name="author" content="Ling Samuel"><script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","name":"Hakurei Shrine","url":"https:\/\/lingsamuel.github.io\/"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/lingsamuel.github.io\/"}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/lingsamuel.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/lingsamuel.github.io\/k8s\/controller\/replicaset\/","name":"Replica set controller 实现"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","author":{"name":"Ling Samuel"},"headline":"ReplicaSet Controller 实现","description":"ReplicationController 的代码已经与 ReplicaSet 合并了。\n","inLanguage":"en","wordCount":2638,"datePublished":"2021-03-09T11:56:11","dateModified":"2021-03-09T11:56:11","image":"https:\/\/lingsamuel.github.io\/","keywords":[""],"mainEntityOfPage":"https:\/\/lingsamuel.github.io\/k8s\/controller\/replicaset\/","publisher":{"@type":"Organization","name":"https:\/\/lingsamuel.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/lingsamuel.github.io\/","height":60,"width":60}}}</script><meta property="og:title" content="ReplicaSet Controller 实现"><meta property="og:description" content="ReplicationController 的代码已经与 ReplicaSet 合并了。"><meta property="og:url" content="https://lingsamuel.github.io/k8s/controller/replicaset/"><meta property="og:type" content="website"><meta property="og:site_name" content="Hakurei Shrine"><meta name="twitter:title" content="ReplicaSet Controller 实现"><meta name="twitter:description" content="ReplicationController 的代码已经与 ReplicaSet 合并了。"><meta name="twitter:card" content="summary"><link href="https://lingsamuel.github.io/img/favicon.ico" rel="icon" type="image/x-icon"><meta name="twitter:card" content="summary"><meta property="og:url" content="https://lingsamuel.github.io/k8s/controller/replicaset/"><meta property="og:type" content="website"><meta property="og:site_name" content="Hakurei Shrine"><link rel="alternate" href="https://lingsamuel.github.io/index.xml" type="application/rss+xml" title="Hakurei Shrine"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&amp;display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code&amp;display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="https://lingsamuel.github.io/css/highlight.min.css"><link rel="stylesheet" href="https://lingsamuel.github.io/css/codeblock.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous"><link rel="stylesheet" href="https://lingsamuel.github.io/css/main.css"><script type="application/javascript">var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-89095899-1','auto'),ga('send','pageview'))</script><script async="" src="https://www.google-analytics.com/analytics.js"></script></head><body id="body"><nav id="navbar" class="navbar navbar-default navbar-fixed-top navbar-custom nav-bottom-border"><div class="container-fluid nav-container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
<a class="navbar-brand" href="https://lingsamuel.github.io/">Hakurei Shrine</a></div><div class="collapse navbar-collapse" id="main-navbar"><ul class="nav navbar-nav navbar-right"><li><a title="Articles" href="/page">Articles</a></li><li><a title="Reviews" href="/review">Reviews</a></li><li><a title="Feeds" href="/feed">Feeds</a></li><li><a title="About" href="/about">About</a></li><li><a title="Categories" href="/categories">Categories</a></li><li><a title="Tags" href="/tags">Tags</a></li></ul></div></div></nav><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title="Share"></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><header class="header-section"><div id="intro-header" class="intro-header no-img" style="margin-top: 98px;"><div class="container"><div class="row"><div class="col-lg-11 col-lg-offset-1"><div class="page-heading"><h1>ReplicaSet Controller 实现</h1><hr class="small"><div class="post-meta" style="display:flex;justify-content:space-between"><span style="display:inline-flex">Posted on March 9, 2021
by Ling Samuel</span><div style="display:inline-flex;font-style:normal"><span></span>&nbsp;
<a style="text-align:right" href="https://lingsamuel.github.io/k8s/replicaset/" onclick="return event.preventDefault(),function(a){navigator.clipboard.writeText(a.href),$(a).prev().text(&quot;url copied&quot;),setTimeout(function(){$(a).prev().text(&quot;&quot;)},1e3)}(this)">Copy Eternal Link</a></div></div><div class="blog-categories"><a href="https://lingsamuel.github.io/categories/kubernetes/">kubernetes</a>&nbsp;</div></div></div></div></div></div></header><div class="container" id="mainContainer" role="main"><div class="row"><div class="col-lg-8 col-lg-offset-1"><article role="main" class="blog-post"><p>ReplicationController 的代码已经与 ReplicaSet 合并了。</p><p>与 Deployment 类似，ReplicaSet 的主要处理函数为 <code>syncHandler</code>，实际执行的是 <code>syncReplicaSet</code>，为实际的 worker。相比 Deployment，RS 没有将 <code>enqueueRS</code> 也抽成变量。这是因为 RS 的业务逻辑比较少，功能较为单一，测试需要的 case 也不需要非常侵入逻辑。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go"><span class="kd">type</span> <span class="nx">ReplicaSetController</span> <span class="kd"><span class="hljs-keyword">struct</span></span> <span class="p">{</span>
	<span class="c1"><span class="hljs-comment">// To allow injection of syncReplicaSet for testing.</span>
</span><span class="c1"></span>	<span class="nx"><span class="hljs-function">syncHandler</span></span><span class="hljs-function"> </span><span class="kd"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">rsKey</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function">error</span></span><span class="hljs-function">
</span><span class="p"><span class="hljs-function">}</span></span><span class="hljs-function">
</span></code></pre></div><h2 id="实现原理">实现原理</h2><p>实线表示持有关系，虚线表示数据流向。</p><div class="mermaidTitle" style="background:#eff1f3;color:#696874"><strong align="center" style="display:block;font-size:24px;font-family:noto sans">ReplicaSet Controller</strong>
<span align="center" style="display:block;font-size:12px;font-family:noto sans">Ling Samuel</span></div><div class="mermaid" align="center" style="background: rgb(239, 241, 243);"><svg id="graph-43250" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="492" style="max-width: 432.68359375px;" viewBox="-16.71875 0 432.68359375 492"><style>#graph-43250{font-family:"trebuchet ms",verdana,arial;font-size:16px;fill:#333;}#graph-43250 .error-icon{fill:#552222;}#graph-43250 .error-text{fill:#552222;stroke:#552222;}#graph-43250 .edge-thickness-normal{stroke-width:2px;}#graph-43250 .edge-thickness-thick{stroke-width:3.5px;}#graph-43250 .edge-pattern-solid{stroke-dasharray:0;}#graph-43250 .edge-pattern-dashed{stroke-dasharray:3;}#graph-43250 .edge-pattern-dotted{stroke-dasharray:2;}#graph-43250 .marker{fill:#333333;}#graph-43250 .marker.cross{stroke:#333333;}#graph-43250 svg{font-family:"trebuchet ms",verdana,arial;font-size:16px;}#graph-43250 .label{font-family:"trebuchet ms",verdana,arial;color:#333;}#graph-43250 .label text{fill:#333;}#graph-43250 .node rect,#graph-43250 .node circle,#graph-43250 .node ellipse,#graph-43250 .node polygon,#graph-43250 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#graph-43250 .node .label{text-align:center;}#graph-43250 .node.clickable{cursor:pointer;}#graph-43250 .arrowheadPath{fill:#333333;}#graph-43250 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#graph-43250 .flowchart-link{stroke:#333333;fill:none;}#graph-43250 .edgeLabel{background-color:#e8e8e8;text-align:center;}#graph-43250 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#graph-43250 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#graph-43250 .cluster text{fill:#333;}#graph-43250 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#graph-43250:root{--mermaid-font-family:"trebuchet ms",verdana,arial;}#graph-43250 .default &gt; *{stroke:#97999a !important;color:#696874 !important;}#graph-43250 .default tspan{fill:#696874 !important;}#graph-43250 .def &gt; *{stroke:#97999a !important;color:#696874 !important;}#graph-43250 .def tspan{fill:#696874 !important;}#graph-43250 .Blue &gt; *{stroke:#97999a !important;fill:#76aac2 !important;color:#eff1f3 !important;}#graph-43250 .Blue tspan{fill:#eff1f3 !important;}#graph-43250 .Grey &gt; *{stroke:#97999a !important;fill:#696773 !important;color:#eef0f2 !important;}#graph-43250 .Grey tspan{fill:#eef0f2 !important;}#graph-43250 .Red &gt; *{stroke:#97999a !important;fill:#f19b97 !important;color:#fcefee !important;}#graph-43250 .Red tspan{fill:#fcefee !important;}#graph-43250 .Green &gt; *{stroke:#97999a !important;fill:#79d8ce !important;color:#edf0f2 !important;}#graph-43250 .Green tspan{fill:#edf0f2 !important;}#graph-43250 .Yellow &gt; *{stroke:#97999a !important;fill:#fcd766 !important;color:#807971 !important;}#graph-43250 .Yellow tspan{fill:#807971 !important;}#graph-43250 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-RSC LE-RSI" id="L-RSC-RSI" style="opacity: 1;"><path class="path" d="M179.1875,45.84946757827519L327.26953125,75L327.26953125,100" marker-end="url(#arrowhead40)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead40" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-RSC LE-PI" id="L-RSC-PI" style="opacity: 1;"><path class="path" d="M114.93079144021739,50L140.33203125,75L140.33203125,100" marker-end="url(#arrowhead41)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead41" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-RSC LE-W" id="L-RSC-W" style="opacity: 1;"><path class="path" d="M46.88586956521739,50L-8.71875,75L-8.71875,121L-8.71875,178L-8.71875,235L-8.71875,292L-8.71875,349L-8.71875,406L100.73828125,447.84759085073495" marker-end="url(#arrowhead42)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead42" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-RSC LE-Queue" id="L-RSC-Queue" style="opacity: 1;"><path class="path" d="M72.76672894021739,50L47.97265625,75L47.97265625,121L47.97265625,178L47.97265625,235L47.97265625,292L153.0390625,335.05695509309965" marker-end="url(#arrowhead43)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead43" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-PI LE-E" id="L-PI-E" style="opacity: 1;"><path class="path" d="M140.33203125,142L140.33203125,178L199.3649259868421,214" marker-end="url(#arrowhead44)" style="fill:none;stroke-width:2px;stroke-dasharray:3;"></path><defs><marker id="arrowhead44" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-RSI LE-E" id="L-RSI-E" style="opacity: 1;"><path class="path" d="M327.26953125,142L327.26953125,178L268.2366365131579,214" marker-end="url(#arrowhead45)" style="fill:none;stroke-width:2px;stroke-dasharray:3;"></path><defs><marker id="arrowhead45" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-E LE-Queue" id="L-E-Queue" style="opacity: 1;"><path class="path" d="M233.80078125,256L233.80078125,292L204.28186677631578,328" marker-end="url(#arrowhead46)" style="fill:none;stroke-width:2px;stroke-dasharray:3;"></path><defs><marker id="arrowhead46" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-Queue LE-W" id="L-Queue-W" style="opacity: 1;"><path class="path" d="M187.0625,370L187.0625,406L157.5731907894737,442" marker-end="url(#arrowhead47)" style="fill:none;stroke-width:2px;stroke-dasharray:3;"></path><defs><marker id="arrowhead47" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-RSC-RSI" class="edgeLabel L-LS-RSC' L-LE-RSI"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-RSC-PI" class="edgeLabel L-LS-RSC' L-LE-PI"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-RSC-W" class="edgeLabel L-LS-RSC' L-LE-W"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-RSC-Queue" class="edgeLabel L-LS-RSC' L-LE-Queue"></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(140.33203125,178)" style="opacity: 1;"><g transform="translate(-36.9140625,-11)" class="label"><rect rx="0" ry="0" width="73.828125" height="22"></rect><foreignObject width="73.828125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-PI-E" class="edgeLabel L-LS-PI' L-LE-E">Pod Event</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(327.26953125,178)" style="opacity: 1;"><g transform="translate(-33.796875,-11)" class="label"><rect rx="0" ry="0" width="67.59375" height="22"></rect><foreignObject width="67.59375" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-RSI-E" class="edgeLabel L-LS-RSI' L-LE-E">RS Event</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(233.80078125,292)" style="opacity: 1;"><g transform="translate(-72.9453125,-11)" class="label"><rect rx="0" ry="0" width="145.890625" height="22"></rect><foreignObject width="145.890625" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-E-Queue" class="edgeLabel L-LS-E' L-LE-Queue">Enqueue ReplicaSet</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(187.0625,406)" style="opacity: 1;"><g transform="translate(-73.3828125,-11)" class="label"><rect rx="0" ry="0" width="146.765625" height="22"></rect><foreignObject width="146.765625" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-Queue-W" class="edgeLabel L-LS-Queue' L-LE-W">Dequeue ReplicaSet</span></div></foreignObject></g></g></g><g class="nodes"><g class="node Green" id="flowchart-RSC-21" transform="translate(93.59375,29)" style="opacity: 1;"><rect rx="5" ry="5" x="-85.59375" y="-21" width="171.1875" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-75.59375,-11)"><foreignObject width="151.1875" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ReplicaSet Controller</div></foreignObject></g></g></g><g class="node Red" id="flowchart-RSI-22" transform="translate(327.26953125,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-80.6953125" y="-21" width="161.390625" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-70.6953125,-11)"><foreignObject width="141.390625" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ReplicaSet Informer</div></foreignObject></g></g></g><g class="node Red" id="flowchart-PI-23" transform="translate(140.33203125,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-56.2421875" y="-21" width="112.484375" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-46.2421875,-11)"><foreignObject width="92.484375" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod Informer</div></foreignObject></g></g></g><g class="node Blue" id="flowchart-E-24" transform="translate(233.80078125,235)" style="opacity: 1;"><rect rx="5" ry="5" x="-58.4765625" y="-21" width="116.953125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48.4765625,-11)"><foreignObject width="96.953125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">EventHandler</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-W-25" transform="translate(140.37109375,463)" style="opacity: 1;"><rect rx="5" ry="5" x="-39.6328125" y="-21" width="79.265625" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-29.6328125,-11)"><foreignObject width="59.265625" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Workers</div></foreignObject></g></g></g><g class="node Red" id="flowchart-Queue-33" transform="translate(187.0625,349)" style="opacity: 1;"><rect rx="0" ry="0" x="-34.0234375" y="-21" width="68.046875" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-24.0234375,-11)"><foreignObject width="48.046875" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Queue</div></foreignObject></g></g></g></g></g></g></svg></div><h3 id="informer">informer</h3><p>ReplicaSet Controller 会监听 ReplicaSet 的增改删，将它们入到工作队列中。当然，删除回调额外对 <code>expectation</code> 做了一些工作，这会在 expectation 一节讲述。</p><p>此外它还监听了 Pod 的增改删，其行为与 Deployment 十分相似。</p><hr><p><code>addPod</code> (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/replicaset/replica_set.go#L356-L356">src</a>):</p><ul><li>如果 Pod 的 DeletionTimestamp 不为空（Controller 重启时可能发生），转交 <code>deletePod</code> 处理。</li><li>如果 Pod 的 Controller 是 RS，那么入工作队列。</li><li>检查是否有 RS 能够收养该 Pod，将能够收养的 RS 入工作队列。</li></ul><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cs" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rsc</span> <span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span> <span class="nf">addPod</span><span class="p">(</span><span class="nx">obj</span> <span class="kd"><span class="hljs-keyword">interface</span></span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">pod</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span>

	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">rsc</span><span class="p">.</span><span class="nf">deletePod</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">return</span></span>
	<span class="p">}</span>

	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">controllerRef</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">GetControllerOf</span><span class="p">(</span><span class="nx">pod</span><span class="p">);</span> <span class="nx">controllerRef</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">rs</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nf">resolveControllerRef</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">controllerRef</span><span class="p">)</span>
		<span class="nx">rsKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">KeyFunc</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
		<span class="nx">rsc</span><span class="p">.</span><span class="nx">expectations</span><span class="p">.</span><span class="nf">CreationObserved</span><span class="p">(</span><span class="nx">rsKey</span><span class="p">)</span>
		<span class="nx">rsc</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">rsKey</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">return</span></span>
	<span class="p">}</span>

	<span class="nx">rss</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nf">getPodReplicaSets</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
	<span class="k"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="nb"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">rss</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="o">==</span> <span class="mi"><span class="hljs-number">0</span></span> <span class="p">{</span>
		<span class="k"><span class="hljs-keyword">return</span></span>
	<span class="p">}</span>
	<span class="k"><span class="hljs-keyword">for</span></span> <span class="nx">_</span><span class="p">,</span> <span class="nx">rs</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rss</span> <span class="p">{</span>
		<span class="nx">rsc</span><span class="p">.</span><span class="nf">enqueueRS</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr><p><code>updatePod</code> (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/replicaset/replica_set.go#L399-L399">src</a>):</p><ul><li>检查新旧 Pod 的资源版本，如果一致（可能由 resync 触发），跳过。</li><li>检查新 Pod 的 DeletionTimestamp 是否非空。如果是，将新 Pod 移交给删除逻辑 <code>deletePod</code>。<ul><li>由于 grace deletion，删除 Pod 时 Kubelet 可能会等待一段时间才会进行删除。但 RS 应该尽快启动新的 Pod，因此在 Update 阶段就检测删除行为。</li><li>如果新旧 Pod 的 Labels 不一致了，同样将旧 Pod 移交给删除逻辑。<ul><li>不需要检查旧 Pod 的删除时间，因为新 Pod 已经被删除了，旧 Pod 也不该继续存在。且因为 Labels 变动，旧 Pod 应该是由其他 RS 管理的，因此需要额外触发一次删除，以清理旧 RS。</li></ul></li></ul></li><li>检查 controller 是否变动。如果变动了，也应该同步旧 rs。</li><li>检查新 Pod 的 controller 是否是 rs，将其入工作队列。<ul><li>由于 Pod 的 MinReadySeconds 的存在，Pod 的状态可能由 NotReady 转向 Ready。应该在 MinReadySeconds 后同步 RS 的 Available Replicas 状态。</li></ul></li><li>只有孤儿 Pod 能走到这一步。检查 Label 或 controller 是否变动了，检查是否有 rs 能够收养，将能够收养的 RS 入工作队列。</li></ul><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs objectivec" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rsc</span> <span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span> <span class="nf">updatePod</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">cur</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">curPod</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Pod</span></span><span class="p">)</span>
	<span class="nx">oldPod</span> <span class="o">:=</span> <span class="nx">old</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Pod</span></span><span class="p">)</span>
	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">curPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">ResourceVersion</span></span> <span class="o">==</span> <span class="nx">oldPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">ResourceVersion</span></span> <span class="p">{</span>
		<span class="k"><span class="hljs-keyword">return</span></span>
	<span class="p">}</span>

	<span class="nx">labelChanged</span> <span class="o">:=</span> <span class="p">!</span><span class="nx">reflect</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">DeepEqual</span></span><span class="p">(</span><span class="nx">curPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Labels</span></span><span class="p">,</span> <span class="nx">oldPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Labels</span></span><span class="p">)</span>
	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">curPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">DeletionTimestamp</span></span> <span class="o">!=</span> <span class="kc"><span class="hljs-literal">nil</span></span> <span class="p">{</span>
		<span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">deletePod</span></span><span class="p">(</span><span class="nx">curPod</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">labelChanged</span> <span class="p">{</span>
			<span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">deletePod</span></span><span class="p">(</span><span class="nx">oldPod</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-keyword">return</span></span>
	<span class="p">}</span>

	<span class="nx">curControllerRef</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">GetControllerOf</span></span><span class="p">(</span><span class="nx">curPod</span><span class="p">)</span>
	<span class="nx">oldControllerRef</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">GetControllerOf</span></span><span class="p">(</span><span class="nx">oldPod</span><span class="p">)</span>
	<span class="nx">controllerRefChanged</span> <span class="o">:=</span> <span class="p">!</span><span class="nx">reflect</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">DeepEqual</span></span><span class="p">(</span><span class="nx">curControllerRef</span><span class="p">,</span> <span class="nx">oldControllerRef</span><span class="p">)</span>
	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">controllerRefChanged</span> <span class="o">&amp;&amp;</span> <span class="nx">oldControllerRef</span> <span class="o">!=</span> <span class="kc"><span class="hljs-literal">nil</span></span> <span class="p">{</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">rs</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">resolveControllerRef</span></span><span class="p">(</span><span class="nx">oldPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Namespace</span></span><span class="p">,</span> <span class="nx">oldControllerRef</span><span class="p">);</span> <span class="nx">rs</span> <span class="o">!=</span> <span class="kc"><span class="hljs-literal">nil</span></span> <span class="p">{</span>
			<span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">enqueueRS</span></span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">curControllerRef</span> <span class="o">!=</span> <span class="kc"><span class="hljs-literal">nil</span></span> <span class="p">{</span>
		<span class="nx">rs</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">resolveControllerRef</span></span><span class="p">(</span><span class="nx">curPod</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Namespace</span></span><span class="p">,</span> <span class="nx">curControllerRef</span><span class="p">)</span>
		<span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">enqueueRS</span></span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="p">!</span><span class="nx">podutil</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">IsPodReady</span></span><span class="p">(</span><span class="nx">oldPod</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">podutil</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">IsPodReady</span></span><span class="p">(</span><span class="nx">curPod</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">rs</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Spec</span></span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">MinReadySeconds</span></span> <span class="p">&gt;</span> <span class="mi"><span class="hljs-number">0</span></span> <span class="p">{</span>
			<span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">enqueueRSAfter</span></span><span class="p">(</span><span class="nx">rs</span><span class="p">,</span> <span class="p">(</span><span class="nx">time</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">Duration</span></span><span class="p">(</span><span class="nx">rs</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Spec</span></span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">MinReadySeconds</span></span><span class="p">)</span><span class="o">*</span><span class="nx">time</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Second</span></span><span class="p">)</span><span class="o">+</span><span class="nx">time</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Second</span></span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k"><span class="hljs-keyword">return</span></span>
	<span class="p">}</span>

	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">labelChanged</span> <span class="o">||</span> <span class="nx">controllerRefChanged</span> <span class="p">{</span>
		<span class="nx">rss</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">getPodReplicaSets</span></span><span class="p">(</span><span class="nx">curPod</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">for</span></span> <span class="nx">_</span><span class="p">,</span> <span class="nx">rs</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rss</span> <span class="p">{</span>
			<span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">enqueueRS</span></span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr><p><code>deletePod</code> (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/replicaset/replica_set.go#L473-L473">src</a>):</p><ul><li>检查 controller 是否是 rs，若是，入工作队列。</li></ul><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cs" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rsc</span> <span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span> <span class="nf">deletePod</span><span class="p">(</span><span class="nx">obj</span> <span class="kd"><span class="hljs-keyword">interface</span></span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">pod</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span>
	<span class="nx">controllerRef</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">GetControllerOf</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
	<span class="nx">rs</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nf">resolveControllerRef</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">controllerRef</span><span class="p">)</span>
	<span class="nx">rsKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">KeyFunc</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
	<span class="nx">rsc</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">rsKey</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>删除逻辑同样有对于 <code>DeletedFinalStateUnknown</code> 的处理，此处依然省略。</p><h3 id="syncreplicaset">syncReplicaSet</h3><p><code>syncReplicaSet</code> 是实际的工作函数 (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/replicaset/replica_set.go#L646-L646">src</a>)。</p><ul><li>取出 ReplicaSet 对象。</li><li>检查缓存是否需要更新。</li><li>取出所有 Pod（而不进行任何过滤），过滤掉不活跃（Phase 为 Succeeded 或 Failed，或 DeletionTimestamp 不为空）的 Pod。<ul><li>取出的 Pod 中可能包含并不符合当前 RS Selector 的 Pods。这是为了能够清理归属于当前 RS，但由于 Selector 变动，需要被释放的 Pod。</li><li>由于 Pod OwnerReference 的 RS 依旧存在（只是 Selector 变动了），Garbage Collector 无法回收这部分 Pod。</li><li>这部分逻辑交由 <code>NewPodControllerRefManager</code> (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/controller_ref_manager.go#L140-L140">src</a>) 完成，是一个通用的 adopt/release 实现。</li></ul></li><li>尝试收养 (<code>claimPods</code>)。这会返回一个符合 Selector 并进行了收养后的 Pod 列表。</li><li>如果需要同步，执行 <code>manageReplicas</code>。</li><li>更新 Status。<ul><li>由于 ReplicaSet 的 Status 可能与创建/删除 Pod 时的错误有关，因此参数中有上一步的返回值。</li></ul></li><li>若 MinReadySeconds &gt; 0，且 ReadyReplicas 或 AvailableReplicas 未达到最大值 (Spec.Replicas)，在延时后重入工作队列。</li></ul><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs sql" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rsc</span> <span class="o">*</span><span class="nx">ReplicaSetController</span><span class="p">)</span> <span class="nf">syncReplicaSet</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx"><span class="hljs-operator"><span class="hljs-keyword">cache</span></span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">SplitMetaNamespaceKey</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">key</span></span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">
	</span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">err</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">rsLister</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">ReplicaSets</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">namespace</span></span><span class="p"><span class="hljs-operator">).</span></span><span class="nf"><span class="hljs-operator"><span class="hljs-keyword">Get</span></span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">name</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">

	</span><span class="nx"><span class="hljs-operator">rsNeedsSync</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">expectations</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">SatisfiedExpectations</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">key</span></span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">
	</span><span class="nx"><span class="hljs-operator">selector</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">err</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">metav1</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">LabelSelectorAsSelector</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Spec</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Selector</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">

	</span><span class="nx"><span class="hljs-operator">allPods</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">err</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">podLister</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">Pods</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Namespace</span></span><span class="p"><span class="hljs-operator">).</span></span><span class="nf"><span class="hljs-operator">List</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">labels</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">Everything</span></span><span class="p"><span class="hljs-operator">())</span></span><span class="hljs-operator">
	</span><span class="nx"><span class="hljs-operator">filteredPods</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">controller</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">FilterActivePods</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">allPods</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">

	</span><span class="nx"><span class="hljs-operator">filteredPods</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">err</span></span><span class="hljs-operator"> </span><span class="p"><span class="hljs-operator">=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">claimPods</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">selector</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">filteredPods</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">

	</span><span class="kd"><span class="hljs-operator"><span class="hljs-keyword">var</span></span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">manageReplicasErr</span></span><span class="hljs-operator"> </span><span class="kt"><span class="hljs-operator">error</span></span><span class="hljs-operator">
	</span><span class="k"><span class="hljs-operator"><span class="hljs-keyword">if</span></span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rsNeedsSync</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">&amp;&amp;</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">DeletionTimestamp</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">==</span></span><span class="hljs-operator"> </span><span class="kc"><span class="hljs-operator">nil</span></span><span class="hljs-operator"> </span><span class="p"><span class="hljs-operator">{</span></span><span class="hljs-operator">
		</span><span class="nx"><span class="hljs-operator">manageReplicasErr</span></span><span class="hljs-operator"> </span><span class="p"><span class="hljs-operator">=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">manageReplicas</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">filteredPods</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">
	</span><span class="p"><span class="hljs-operator">}</span></span><span class="hljs-operator">

	</span><span class="nx"><span class="hljs-operator">rs</span></span><span class="hljs-operator"> </span><span class="p"><span class="hljs-operator">=</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">DeepCopy</span></span><span class="p"><span class="hljs-operator">()</span></span><span class="hljs-operator">
	</span><span class="nx"><span class="hljs-operator">newStatus</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nf"><span class="hljs-operator">calculateStatus</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">filteredPods</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">manageReplicasErr</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">
	</span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">err</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">:=</span></span><span class="hljs-operator"> </span><span class="nf"><span class="hljs-operator">updateReplicaSetStatus</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">kubeClient</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">AppsV1</span></span><span class="p"><span class="hljs-operator">().</span></span><span class="nf"><span class="hljs-operator">ReplicaSets</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Namespace</span></span><span class="p"><span class="hljs-operator">),</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">rs</span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">newStatus</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">

	</span><span class="k"><span class="hljs-operator"><span class="hljs-keyword">if</span></span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">manageReplicasErr</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">==</span></span><span class="hljs-operator"> </span><span class="kc"><span class="hljs-operator">nil</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">&amp;&amp;</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Spec</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">MinReadySeconds</span></span><span class="hljs-operator"> </span><span class="p"><span class="hljs-operator">&gt;</span></span><span class="hljs-operator"> </span><span class="mi"><span class="hljs-operator"><span class="hljs-number">0</span></span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">&amp;&amp;</span></span><span class="hljs-operator">
		</span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">Status</span></span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">ReadyReplicas</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">==</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">*</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Spec</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Replicas</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">&amp;&amp;</span></span><span class="hljs-operator">
		</span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">Status</span></span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">AvailableReplicas</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">!=</span></span><span class="hljs-operator"> </span><span class="o"><span class="hljs-operator">*</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Spec</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Replicas</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator"> </span><span class="p"><span class="hljs-operator">{</span></span><span class="hljs-operator">
		</span><span class="nx"><span class="hljs-operator">rsc</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">queue</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">AddAfter</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">key</span></span></span><span class="p"><span class="hljs-operator">,</span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">time</span></span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nf"><span class="hljs-operator">Duration</span></span><span class="p"><span class="hljs-operator">(</span></span><span class="nx"><span class="hljs-operator">updatedRS</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">Spec</span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator">MinReadySeconds</span></span><span class="p"><span class="hljs-operator">)</span></span><span class="o"><span class="hljs-operator">*</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">time</span></span></span><span class="p"><span class="hljs-operator">.</span></span><span class="nx"><span class="hljs-operator"><span class="hljs-keyword">Second</span></span></span><span class="p"><span class="hljs-operator">)</span></span><span class="hljs-operator">
	</span><span class="p"><span class="hljs-operator">}</span></span><span class="hljs-operator">
	</span><span class="k"><span class="hljs-operator"><span class="hljs-keyword">return</span></span></span><span class="hljs-operator"> </span><span class="nx"><span class="hljs-operator">manageReplicasErr</span></span><span class="hljs-operator">
</span><span class="p"><span class="hljs-operator">}</span></span><span class="hljs-operator">
</span></code></pre></div><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>Note:</strong><p>本地 TTL 缓存 <code>expectations</code> 稍后会提到。</p></div><h3 id="managereplicas">manageReplicas</h3><p>实际进行扩缩容的工作函数。扩缩容可由数量差决定 (<a href="https://github.com/kubernetes/kubernetes/blob/16b909ce1483258464715c9ab76b4dff82d596e5/pkg/controller/replicaset/replica_set.go#L541-L541">src</a>)：</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs css" data-lang="go"><span class="kd"><span class="hljs-tag">func</span></span> <span class="p">(</span><span class="nx"><span class="hljs-tag">rsc</span></span> <span class="o">*</span><span class="nx"><span class="hljs-tag">ReplicaSetController</span></span><span class="p">)</span> <span class="nf"><span class="hljs-tag">manageReplicas</span></span><span class="p">(</span><span class="nx"><span class="hljs-tag">filteredPods</span></span> <span class="p"><span class="hljs-attr_selector">[]</span></span><span class="o">*</span><span class="nx"><span class="hljs-tag">v1</span></span><span class="p"><span class="hljs-class">.</span></span><span class="nx"><span class="hljs-class">Pod</span></span><span class="p">,</span> <span class="nx"><span class="hljs-tag">rs</span></span> <span class="o">*</span><span class="nx"><span class="hljs-tag">apps</span></span><span class="p"><span class="hljs-class">.</span></span><span class="nx"><span class="hljs-class">ReplicaSet</span></span><span class="p">)</span> <span class="kt"><span class="hljs-tag">error</span></span> <span class="p"><span class="hljs-rules">{</span></span><span class="hljs-rules">
	</span><span class="nx"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-attribute">diff</span></span></span></span><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-attribute"> </span></span></span><span class="o"><span class="hljs-rules"><span class="hljs-rule">:<span class="hljs-value">=</span></span></span></span><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value"> </span></span></span><span class="nb"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value"><span class="hljs-function">len</span></span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">(</span></span></span></span><span class="nx"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">filteredPods</span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">)</span></span></span></span><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value"> </span></span></span><span class="o"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">-</span></span></span></span><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value"> </span></span></span><span class="nb"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value"><span class="hljs-function">int</span></span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">(</span></span></span></span><span class="o"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">*</span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">(</span></span></span></span><span class="nx"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">rs</span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">.</span></span></span></span><span class="nx"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">Spec</span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">.</span></span></span></span><span class="nx"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">Replicas</span></span></span></span><span class="p"><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">))</span></span></span></span><span class="hljs-rules"><span class="hljs-rule"><span class="hljs-value">
</span></span></span></code></pre></div><p>已有 Pod 更多时，<code>diff &gt; 0</code>，需要缩容；反之则需要扩容。</p><p>在操作时，一次同步最多操作 500 个 Pod。这是一个固定写死的参数 (<code>BurstReplicas = 500</code>)。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cpp" data-lang="go">	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&lt;</span> <span class="mi"><span class="hljs-number">0</span></span> <span class="p">{</span>
		<span class="nx">diff</span> <span class="o">*=</span> <span class="o">-</span><span class="mi"><span class="hljs-number">1</span></span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&gt;</span> <span class="nx">rsc</span><span class="p">.</span><span class="nx">burstReplicas</span> <span class="p">{</span>
			<span class="nx">diff</span> <span class="p">=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nx">burstReplicas</span>
		<span class="p">}</span>
		<span class="c1"><span class="hljs-comment">// ...</span>
</span><span class="c1"></span>	<span class="p">}</span> <span class="k"><span class="hljs-keyword">else</span></span> <span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&gt;</span> <span class="mi"><span class="hljs-number">0</span></span> <span class="p">{</span>
		<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&gt;</span> <span class="nx">rsc</span><span class="p">.</span><span class="nx">burstReplicas</span> <span class="p">{</span>
			<span class="nx">diff</span> <span class="p">=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nx">burstReplicas</span>
		<span class="p">}</span>
		<span class="c1"><span class="hljs-comment">// ...</span>
</span><span class="c1"></span>	<span class="p">}</span>
</code></pre></div><h4 id="扩容">扩容</h4><p>和 Deployment 不同。虽然 ReplicaSet 没有 MaxSurge/MaxUnavailable 参数，它依旧不能并发地创建所有所需的 Pod。</p><p>主要原因在于有许多情况下，Pod 的创建会因同一种原因失败（例如资源不足）。如果并发地创建所有的 Pod，可能会给 API Server 带来不必要的负载。</p><p>ReplicaSet 和一些其他的资源（例如 Job），使用称为 <code>slowStart</code> 的机制来创建 Pod。它会首先创建 1 个 Pod，然后每次加倍。任意一次创建不是全部成功，则直接退出，不再创建剩余 Pod。</p><p>注意，此处的创建函数有一个特判。当错误是 NS 被删除时，为了避免 RS 每次同步都重复操作，它会忽略掉这个报错，假装创建成功了。虽然可以提前终止整个创建流程，但目前来看这个行为不是一个很严重的性能问题。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs objectivec" data-lang="go">	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&lt;</span> <span class="mi"><span class="hljs-number">0</span></span> <span class="p">{</span>
		<span class="c1"><span class="hljs-comment">// ...</span>
</span><span class="c1"></span>		<span class="nx">successfulCreations</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">slowStartBatch</span><span class="p">(</span><span class="nx">diff</span><span class="p">,</span> <span class="nx">controller</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">SlowStartInitialBatchSize</span></span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">podControl</span></span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">CreatePodsWithControllerRef</span></span><span class="p">(</span><span class="nx">rs</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Namespace</span></span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rs</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Spec</span></span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">Template</span></span><span class="p">,</span> <span class="nx">rs</span><span class="p">,</span> <span class="nx">metav1</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">NewControllerRef</span></span><span class="p">(</span><span class="nx">rs</span><span class="p">,</span> <span class="nx">rsc</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">GroupVersionKind</span></span><span class="p">))</span>
			<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc"><span class="hljs-literal">nil</span></span> <span class="p">{</span>
				<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">errors</span><span class="p"><span class="hljs-variable">.</span></span><span class="nf"><span class="hljs-variable">HasStatusCause</span></span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">v1</span><span class="p"><span class="hljs-variable">.</span></span><span class="nx"><span class="hljs-variable">NamespaceTerminatingCause</span></span><span class="p">)</span> <span class="p">{</span>
					<span class="k"><span class="hljs-keyword">return</span></span> <span class="kc"><span class="hljs-literal">nil</span></span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">err</span>
		<span class="p">})</span>
		<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">err</span>
	<span class="p">}</span>
</code></pre></div><h4 id="缩容">缩容</h4><p>缩容要更加复杂一点。</p><p>在删除 Pod 时，它会首先删除在生命周期早期的 Pod。具体来说，它会按此顺序排序 Pod：</p><ul><li>Unscheduled &lt; Scheduled</li><li>Pending &lt; Unknown &lt; Running</li><li>Not Ready &lt; Ready</li><li>节点上相关 Pod 更多 &lt; 节点上相关 Pod 更少</li><li>Running 时间更短 &lt; Running 时间更长</li><li>Restart 次数更多 &lt; Restart 次数更少</li><li>创建时间更近 &lt; 创建时间更早</li></ul><p>这个顺序可以保证删除 Pod 时，尽量避免删除存活可用的 Pod，也能避免调度等流程重新被执行。</p><p>除了生命周期规则外，注意“节点上相关 Pod”（此处称为 Rank）这一规则。</p><p>由于 ReplicaSet 被设计成可能被其他控制器管理的资源，因此可能有多个 RS 管理着一组相似的 Pod（比如 Deployment）。</p><div class="mermaidTitle" style="background:#eff1f3;color:#696874"><strong align="center" style="display:block;font-size:24px;font-family:noto sans">Related Pods</strong>
<span align="center" style="display:block;font-size:12px;font-family:noto sans">Ling Samuel</span></div><div class="mermaid" align="center" style="background: rgb(239, 241, 243);"><svg id="graph-14206" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="334" style="max-width: 418.140625px;" viewBox="0 0 418.140625 334"><style>#graph-14206{font-family:"trebuchet ms",verdana,arial;font-size:16px;fill:#333;}#graph-14206 .error-icon{fill:#552222;}#graph-14206 .error-text{fill:#552222;stroke:#552222;}#graph-14206 .edge-thickness-normal{stroke-width:2px;}#graph-14206 .edge-thickness-thick{stroke-width:3.5px;}#graph-14206 .edge-pattern-solid{stroke-dasharray:0;}#graph-14206 .edge-pattern-dashed{stroke-dasharray:3;}#graph-14206 .edge-pattern-dotted{stroke-dasharray:2;}#graph-14206 .marker{fill:#333333;}#graph-14206 .marker.cross{stroke:#333333;}#graph-14206 svg{font-family:"trebuchet ms",verdana,arial;font-size:16px;}#graph-14206 .label{font-family:"trebuchet ms",verdana,arial;color:#333;}#graph-14206 .label text{fill:#333;}#graph-14206 .node rect,#graph-14206 .node circle,#graph-14206 .node ellipse,#graph-14206 .node polygon,#graph-14206 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#graph-14206 .node .label{text-align:center;}#graph-14206 .node.clickable{cursor:pointer;}#graph-14206 .arrowheadPath{fill:#333333;}#graph-14206 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#graph-14206 .flowchart-link{stroke:#333333;fill:none;}#graph-14206 .edgeLabel{background-color:#e8e8e8;text-align:center;}#graph-14206 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#graph-14206 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#graph-14206 .cluster text{fill:#333;}#graph-14206 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#graph-14206:root{--mermaid-font-family:"trebuchet ms",verdana,arial;}#graph-14206 .default &gt; *{stroke:#97999a !important;color:#696874 !important;}#graph-14206 .default tspan{fill:#696874 !important;}#graph-14206 .def &gt; *{stroke:#97999a !important;color:#696874 !important;}#graph-14206 .def tspan{fill:#696874 !important;}#graph-14206 .Blue &gt; *{stroke:#97999a !important;fill:#76aac2 !important;color:#eff1f3 !important;}#graph-14206 .Blue tspan{fill:#eff1f3 !important;}#graph-14206 .Grey &gt; *{stroke:#97999a !important;fill:#696773 !important;color:#eef0f2 !important;}#graph-14206 .Grey tspan{fill:#eef0f2 !important;}#graph-14206 .Red &gt; *{stroke:#97999a !important;fill:#f19b97 !important;color:#fcefee !important;}#graph-14206 .Red tspan{fill:#fcefee !important;}#graph-14206 .Green &gt; *{stroke:#97999a !important;fill:#79d8ce !important;color:#edf0f2 !important;}#graph-14206 .Green tspan{fill:#edf0f2 !important;}#graph-14206 .Yellow &gt; *{stroke:#97999a !important;fill:#fcd766 !important;color:#807971 !important;}#graph-14206 .Yellow tspan{fill:#807971 !important;}#graph-14206 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-D LE-R1" id="L-D-R1" style="opacity: 1;"><path class="path" d="M153.34748641304347,50L89.921875,75L89.921875,100" marker-end="url(#arrowhead71)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead71" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-D LE-R2" id="L-D-R2" style="opacity: 1;"><path class="path" d="M257.66983695652175,50L318.4375,75L318.4375,100" marker-end="url(#arrowhead72)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead72" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-R1 LE-P1" id="L-R1-P1" style="opacity: 1;"><path class="path" d="M66.6321331521739,142L38.90625,167L38.90625,192" marker-end="url(#arrowhead73)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead73" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-R1 LE-P2" id="L-R1-P2" style="opacity: 1;"><path class="path" d="M117.67697010869566,142L150.71875,167L150.71875,192" marker-end="url(#arrowhead74)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead74" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-R2 LE-P3" id="L-R2-P3" style="opacity: 1;"><path class="path" d="M292.9150815217391,142L262.53125,167L262.53125,192" marker-end="url(#arrowhead75)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead75" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-R2 LE-P4" id="L-R2-P4" style="opacity: 1;"><path class="path" d="M343.9599184782609,142L374.34375,167L374.34375,192" marker-end="url(#arrowhead76)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead76" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-P1 LE-N1" id="L-P1-N1" style="opacity: 1;"><path class="path" d="M38.90625,234L38.90625,259L114.921875,290.2730575740637" marker-end="url(#arrowhead77)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead77" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-P2 LE-N1" id="L-P2-N1" style="opacity: 1;"><path class="path" d="M150.71875,234L150.71875,259L150.71875,284" marker-end="url(#arrowhead78)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead78" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-P3 LE-N1" id="L-P3-N1" style="opacity: 1;"><path class="path" d="M262.53125,234L262.53125,259L186.515625,290.2730575740637" marker-end="url(#arrowhead79)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead79" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-P4 LE-N2" id="L-P4-N2" style="opacity: 1;"><path class="path" d="M374.34375,234L374.34375,259L374.34375,284" marker-end="url(#arrowhead80)" style="fill:none;stroke:grey;"></path><defs><marker id="arrowhead80" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-D-R1" class="edgeLabel L-LS-D' L-LE-R1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-D-R2" class="edgeLabel L-LS-D' L-LE-R2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-R1-P1" class="edgeLabel L-LS-R1' L-LE-P1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-R1-P2" class="edgeLabel L-LS-R1' L-LE-P2"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-R2-P3" class="edgeLabel L-LS-R2' L-LE-P3"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-R2-P4" class="edgeLabel L-LS-R2' L-LE-P4"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-P1-N1" class="edgeLabel L-LS-P1' L-LE-N1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-P2-N1" class="edgeLabel L-LS-P2' L-LE-N1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-P3-N1" class="edgeLabel L-LS-P3' L-LE-N1"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span id="L-L-P4-N2" class="edgeLabel L-LS-P4' L-LE-N2"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node Green" id="flowchart-D-71" transform="translate(206.625,29)" style="opacity: 1;"><rect rx="5" ry="5" x="-59.359375" y="-21" width="118.71875" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-49.359375,-11)"><foreignObject width="98.71875" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Parent Owner</div></foreignObject></g></g></g><g class="node Red" id="flowchart-R1-72" transform="translate(89.921875,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-55.359375" y="-21" width="110.71875" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-45.359375,-11)"><foreignObject width="90.71875" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ReplicaSet 1</div></foreignObject></g></g></g><g class="node Red" id="flowchart-R2-73" transform="translate(318.4375,121)" style="opacity: 1;"><rect rx="5" ry="5" x="-55.359375" y="-21" width="110.71875" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-45.359375,-11)"><foreignObject width="90.71875" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ReplicaSet 2</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-P1-74" transform="translate(38.90625,213)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.90625" y="-21" width="61.8125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.90625,-11)"><foreignObject width="41.8125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod 1</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-P2-75" transform="translate(150.71875,213)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.90625" y="-21" width="61.8125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.90625,-11)"><foreignObject width="41.8125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod 2</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-P3-76" transform="translate(262.53125,213)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.90625" y="-21" width="61.8125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.90625,-11)"><foreignObject width="41.8125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod 3</div></foreignObject></g></g></g><g class="node Yellow" id="flowchart-P4-77" transform="translate(374.34375,213)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.90625" y="-21" width="61.8125" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.90625,-11)"><foreignObject width="41.8125" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Pod 4</div></foreignObject></g></g></g><g class="node Grey" id="flowchart-N1-78" transform="translate(150.71875,305)" style="opacity: 1;"><rect rx="5" ry="5" x="-35.796875" y="-21" width="71.59375" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-25.796875,-11)"><foreignObject width="51.59375" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Node 1</div></foreignObject></g></g></g><g class="node Grey" id="flowchart-N2-79" transform="translate(374.34375,305)" style="opacity: 1;"><rect rx="5" ry="5" x="-35.796875" y="-21" width="71.59375" height="42" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-25.796875,-11)"><foreignObject width="51.59375" height="22"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Node 2</div></foreignObject></g></g></g></g></g></g></svg></div><p>以上图为例，Pod 1~3 均分布在 Node 1 上，而 Pod 4 分布在 Node 2 上。且管理这些 Pod 的 ReplicaSet 拥有共同的 Owner。这时候，Pod 1~3 的 Rank 为 3，而 Pod 4 则为 1。</p><p>可以发现，如果保持相关 Pod 的 Rank 尽可能低，那么会拥有更好的可用性（Pod 更加分散了）。因此会在生命周期规则之后优先删除高 Rank 的 Pod。</p><div class="highlight"><pre class="chroma" style="padding: 0px;"><code class="language-go hljs cs" data-lang="go">	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&gt;</span> <span class="mi"><span class="hljs-number">0</span></span> <span class="p">{</span>
		<span class="c1"><span class="hljs-comment">// ...</span>
</span><span class="c1"></span>		<span class="nx">relatedPods</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nf">getIndirectlyRelatedPods</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
		<span class="nx">podsToDelete</span> <span class="o">:=</span> <span class="nf">getPodsToDelete</span><span class="p">(</span><span class="nx">filteredPods</span><span class="p">,</span> <span class="nx">relatedPods</span><span class="p">,</span> <span class="nx">diff</span><span class="p">)</span>

		<span class="kd"><span class="hljs-keyword">var</span></span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">diff</span><span class="p">)</span>
		<span class="k"><span class="hljs-keyword">for</span></span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">podsToDelete</span> <span class="p">{</span>
			<span class="k"><span class="hljs-function">go</span></span><span class="hljs-function"> </span><span class="kd"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">targetPod</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">*</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">v1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">Pod</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="p">{</span>
				<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
				<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rsc</span><span class="p">.</span><span class="nx">podControl</span><span class="p">.</span><span class="nf">DeletePod</span><span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">targetPod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">rs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="p">}</span>
			<span class="p">}(</span><span class="nx">pod</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd"><span class="hljs-function">func</span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">getPodsToDelete</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">filteredPods</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">relatedPods</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="o"><span class="hljs-function"><span class="hljs-params">*</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">v1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">Pod</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="nx"><span class="hljs-function"><span class="hljs-params">diff</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="p"><span class="hljs-function">[]</span></span><span class="o"><span class="hljs-function">*</span></span><span class="nx"><span class="hljs-function">v1</span></span><span class="p"><span class="hljs-function">.</span></span><span class="nx"><span class="hljs-function">Pod</span></span><span class="hljs-function"> </span><span class="p">{</span>
	<span class="k"><span class="hljs-keyword">if</span></span> <span class="nx">diff</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">filteredPods</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">podsWithRanks</span> <span class="o">:=</span> <span class="nf">getPodsRankedByRelatedPodsOnSameNode</span><span class="p">(</span><span class="nx">filteredPods</span><span class="p">,</span> <span class="nx">relatedPods</span><span class="p">)</span>
		<span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nx">podsWithRanks</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k"><span class="hljs-keyword">return</span></span> <span class="nx">filteredPods</span><span class="p">[:</span><span class="nx">diff</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div><p>由于 ReplicaSet 的删除工作是单纯的缩容（而不是 RollingUpdate），因此删除是可以完全并发完成的。</p><h3 id="expectation">expectation</h3><div class="alert alert-info"><svg class="svg-inline fa-w-11" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"></path></svg><strong>TODO</strong></div><h2 id="总结">总结</h2><p>ReplicaSet Controller 的实现虽然比较直接，但也能发现逐渐的演进过程。例如，最初的 ReplicaSet 缩容没有考虑 Rank 而只考虑 Pod 生命周期；创建 Pod 时也不会忽略 NS 正在被删除的错误（会产生大量日志）；没有 slow start，等等。</p><p>从 ReplicaSet 的演进中可以发现，一个看似简单的功能，随着系统的复杂化，也可以演变出很多高级的特性。完成一个功能，与这个功能好用而完善，还有一段相当的距离。</p><p>在平时的使用中，一般是不会直接使用 ReplicaSet 的。但如果需要实现定制化的控制器，就可能需要依赖 ReplicaSet 来实现。</p><div id="refContainer"></div></article><ul class="pager blog-pager"><li class="previous"><a href="https://lingsamuel.github.io/k8s/controller/pod-gc/" data-toggle="tooltip" data-placement="top" title="Pod GC Controller">← Previous Post</a></li></ul></div><aside id="toc" class="col-lg-2" style="top: 78px;"><nav id="TableOfContents"><ul><li class="active"><a href="#实现原理">实现原理</a><ul><li><a href="#informer">informer</a></li><li><a href="#syncreplicaset">syncReplicaSet</a></li><li><a href="#managereplicas">manageReplicas</a></li><li><a href="#expectation">expectation</a></li></ul></li><li><a href="#总结">总结</a></li></ul></nav></aside></div></div><footer><div class="container"><div class="row"><div class="col-lg-10 col-lg-offset-1"><ul class="list-inline text-center footer-links"><li><a href="mailto:lingsamuelgrace@gmail.com" title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://github.com/lingsamuel" title="GitHub"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://lingsamuel.github.io/index.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href="https://lingsamuel.github.io">Ling Samuel</a>
&nbsp;•&nbsp;©
2021
&nbsp;•&nbsp;
<a href="https://lingsamuel.github.io/">Hakurei Shrine</a></p><p class="credits theme-by text-muted"><a href="http://gohugo.io">Hugo v0.81.0</a> powered &nbsp;•&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> Modified by <a href="https://github.com/lingsamuel/beautifulhugo">LingSamuel</a></p></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script><script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><script src="https://lingsamuel.github.io/js/main.js"></script><link href="https://lingsamuel.github.io/css/mermaid.css" type="text/css" rel="stylesheet"><script src="https://lingsamuel.github.io/js/mermaid.min.js"></script><script src="https://lingsamuel.github.io/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();const mermaidKeywords=["graph TD","graph TB","graph BT","graph RL","graph LR","sequenceDiagram","gantt","classDiagram","gitGraph","erDiagram","journey"];function colorizeMermaid(a){const b=`
    linkStyle default fill:none,stroke:grey;
    classDef default stroke:#97999a,color:#696874;
    classDef def stroke:#97999a,color:#696874;
    classDef Blue stroke:#97999a,fill:#76aac2,color:#eff1f3;
    classDef Grey stroke:#97999a,fill:#696773,color:#eef0f2;
    classDef Red stroke:#97999a,fill:#f19b97,color:#fcefee;
    classDef Green stroke:#97999a,fill:#79d8ce,color:#edf0f2;
    classDef Yellow stroke:#97999a,fill:#fcd766,color:#807971;`;return a.startsWith("graph")?a+b:a}var elements=$(".language-fallback").each((d,b)=>{var c=b.innerText,a;mermaidKeywords.some(a=>c.startsWith(a))&&(a=b.parentElement.parentElement,a.className=="highlight"&&(a.className="mermaid",a.innerHTML=colorizeMermaid(c),a.align="center",a.style="background: #eff1f3;"))})</script><script>mermaid.initialize({startOnLoad:!1}),mermaid.mermaidAPI.initialize(),document.querySelectorAll('.mermaid').forEach(function(a){let b=a.textContent;console.log("Rendering ",b);let c='graph-'+Math.floor(Math.random()*Math.floor(1e5));mermaid.mermaidAPI.render(c,b,b=>{a.innerHTML=b})})</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://lingsamuel.github.io/js/load-photoswipe.js"></script></body></html>